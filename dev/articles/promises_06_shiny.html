<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using promises with Shiny • promises</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Using promises with Shiny">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">promises</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.3.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Learning

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/promises_01_motivation.html">1. Why use promises?</a>
    </li>
    <li>
      <a href="../articles/promises_02_intro.html">2. An informal intro to async programming</a>
    </li>
    <li>
      <a href="../articles/promises_03_overview.html">3. Working with promises</a>
    </li>
    <li>
      <a href="../articles/promises_04_futures.html">4. Launching tasks with future</a>
    </li>
    <li>
      <a href="../articles/promises_05_future_promise.html">5. Advanced future and promises usage</a>
    </li>
    <li>
      <a href="../articles/promises_06_shiny.html">6. Using promises with Shiny</a>
    </li>
    <li>
      <a href="../articles/promises_07_combining.html">7. Combining promises</a>
    </li>
    <li>
      <a href="../articles/promises_08_casestudy.html">8. Case study: Converting a Shiny app to async</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/promises/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>

    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using promises with Shiny</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/promises/blob/main/vignettes/promises_06_shiny.Rmd" class="external-link"><code>vignettes/promises_06_shiny.Rmd</code></a></small>
      <div class="hidden name"><code>promises_06_shiny.Rmd</code></div>

    </div>

    
    
<style>
.alert-success a {
  color: white;
  text-decoration: underline;
}
</style>
<div class="alert alert-success">
<p>As of Shiny 1.8.1, there is a new feature called <strong>Extended
Tasks</strong> that has several advantages over the approach in this
article. We highly recommend that you read <a href="https://shiny.posit.co/r/articles/improve/nonblocking/" class="external-link">the
Extended Task documentation</a> first.</p>
</div>
<p>Taking advantage of async programming from Shiny is not as simple as
turning on an option or flipping a switch. If you have already written a
Shiny application and are looking to improve its scalability, expect the
changes required for async operation to ripple through multiple layers
of server code.</p>
<p>Async programming with Shiny boils down to following a few steps.</p>
<ol style="list-style-type: decimal">
<li><p>Identify slow operations (function calls or blocks of statements)
in your app.</p></li>
<li><p>Convert the slow operation into a future using
<code><a href="../reference/future_promise.html">future_promise()</a></code>. (If you haven’t read the <a href="promises_04_futures.html">article on futures</a> and <a href="promises_05_future_promise.html"><code>future_promise()</code></a>,
definitely do that before proceeding!)</p></li>
<li><p>Any code that relies on the result of that operation (if any),
whether directly or indirectly, now must be converted to promise
handlers that operate on the future object.</p></li>
</ol>
<p>We’ll get into details for all these steps, but first, an example.
Consider the following synchronous server code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">plot</span> <span class="op">&lt;-</span> <span class="fu">renderPlot</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">expensive_operation</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">result</span>, <span class="va">input</span><span class="op">$</span><span class="va">n</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We’d convert it to async like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/promises/">promises</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">plot</span> <span class="op">&lt;-</span> <span class="fu">renderPlot</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span> <span class="fu">expensive_operation</span><span class="op">(</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level2">
<h2 id="adding-prerequisites">Adding prerequisites<a class="anchor" aria-label="anchor" href="#adding-prerequisites"></a>
</h2>
<p>The easiest part is adding <code><a href="https://rstudio.github.io/promises/">library(promises)</a></code>,
<code><a href="https://future.futureverse.org" class="external-link">library(future)</a></code>, and <code>plan(multisession)</code> to the
top of the app.</p>
<p>The <code>promises</code> library is necessary for the
<code>%...&gt;%</code> operator. You may also want to use promise
utility functions like <code>promise_all</code> and
<code>promise_race</code>.</p>
<p>The <code>future</code> library is needed because the
<code><a href="https://future.futureverse.org/reference/future.html" class="external-link">future()</a></code> function call used inside
<code><a href="../reference/future_promise.html">future_promise()</a></code> is how you will launch asynchronous
tasks.</p>
<p><code>plan(multisession)</code> is a directive to the
<code>future</code> package, telling it how future tasks should actually
be executed. See the <a href="promises_04_futures.html">article on
futures</a> for more details.</p>
</div>
<div class="section level2">
<h2 id="identifying-slow-operations">Identifying slow operations<a class="anchor" aria-label="anchor" href="#identifying-slow-operations"></a>
</h2>
<p>To find areas of your code that are good candidates for the
future/promise treatment, let’s start with the obvious: identifying the
code that is making your app slow. You may assume it’s your plotting
code that’s slow, but it’s actually your database queries; or vice
versa. If there’s one thing that veteran programmers can agree on, it’s
that human intuition is a surprisingly unreliable tool for spotting
performance problems.</p>
<p>Our recommendation is that you use the <a href="https://rstudio.github.io/profvis/" class="external-link">profvis</a> profiler, which we
designed to work with Shiny (see Example 3 in the profvis
documentation). You can use profvis to help you focus in on where the
time is actually being spent in your app.</p>
<blockquote>
<p><strong>Note:</strong> As of this writing, profvis doesn’t work
particularly well for diagnosing performance problems in parts of your
code that you’ve already made asynchronous. In particular, we haven’t
done any work to help it profile code that executes in a future, and the
mechanism we use to hide “irrelevant” parts of the stack trace doesn’t
work well with promises. These are ripe areas for future
development.</p>
</blockquote>
<p>Async programming works well when you can identify just a few
“hotspots” in your app where lots of time is being spent. It works much
less well if your app is too slow because of a generalized, diffuse
slowness through every aspect of your app, where no one operation takes
too much time but it all adds up to a lot. The more futures you need to
introduce into your app, the more fixed communication overhead you
incur. So for the most bang-for-the-buck, we want to launch a small
number of futures per session but move a lot of the waited-on code into
each one.</p>
</div>
<div class="section level2">
<h2 id="converting-a-slow-operation-into-a-future">Converting a slow operation into a future<a class="anchor" aria-label="anchor" href="#converting-a-slow-operation-into-a-future"></a>
</h2>
<p>Now that we’ve found hotspots that we want to make asynchronous,
let’s talk about the actual work of converting them to futures.</p>
<p>Conceptually, futures work like this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/future.html" class="external-link">future</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># Expensive code goes here</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span> <span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Code to handle result of expensive code goes here</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>which seems incredibly simple. What’s actually happening is that the
future runs in a totally separate child R process, and then the result
is collected up and returned to the main R process:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Code here runs in process A</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/future.html" class="external-link">future</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># Code here runs in (child) process B</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span> <span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Code here runs in process A</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The fact that the future code block executes in a separate process
means we have to take special care to deal with a number of practical
issues. There are extremely important constraints that futures impose on
their code blocks; certain objects cannot be safely used across process
boundaries, and some of the default behaviors of the future library may
severely impact the performance of your app. Again, see the <a href="promises_04_futures.html">article on futures</a> for more
details.</p>
<p>The remainder of this document will use <code><a href="../reference/future_promise.html">future_promise()</a></code>
in place of <code><a href="https://future.futureverse.org/reference/future.html" class="external-link">future()</a></code>. For more information on the
differences, see the <a href="promises_05_future_promise.html">article
on the benefits of <code>future_promise()</code></a>.</p>
<div class="section level3">
<h3 id="shiny-specific-caveats-and-limitations">Shiny-specific caveats and limitations<a class="anchor" aria-label="anchor" href="#shiny-specific-caveats-and-limitations"></a>
</h3>
<p>In addition to the constraints that all futures face, there is an
additional one for Shiny: reactive values and reactive expressions
cannot be read from within a future. Whenever reactive
values/expressions are read, side effects are carried out under the hood
so that the currently executing observer or reactive expression can be
notified when the reactive value/expression becomes invalidated. If a
reactive value/expression is created in one process, but read in another
process, there will be no way for readers to be notified about
invalidation.</p>
<p>This code, for example, will not work:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span> <span class="va">...</span> <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="fu">r1</span><span class="op">(</span><span class="op">)</span> <span class="co"># Will error--don't do this!</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Even though <code>r1()</code> is called from inside the
<code>r2</code> reactive expression, the fact that it’s also in a future
means the call will fail. Instead, you must read any reactive
values/expressions you need in advance of launching the future:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span> <span class="va">...</span> <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">val</span> <span class="op">&lt;-</span> <span class="fu">r1</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="va">val</span> <span class="co"># No problem!</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>However, it’s perfectly fine to read reactive values/expressions from
inside a promise <em>handler</em>. Handlers run in the original process,
not a child process, so reactive operations are allowed.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span> <span class="va">...</span> <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span> <span class="va">...</span> <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu">r1</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># OK!</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="integrating-promises-with-shiny">Integrating promises with Shiny<a class="anchor" aria-label="anchor" href="#integrating-promises-with-shiny"></a>
</h2>
<p>Generally, you’ll be using promises with Shiny from within outputs,
reactive expressions, and observers. We’ve tried to integrate promises
into these constructs in as natural a way as possible.</p>
<div class="section level3">
<h3 id="outputs">Outputs<a class="anchor" aria-label="anchor" href="#outputs"></a>
</h3>
<p>Most outputs (<code>renderXXX({ ... })</code>) functions expect your
code block to return a value; for example, <code>renderText()</code>
expects a character vector and <code>renderTable()</code> expects a data
frame. All such render functions that are included within the
<code>shiny</code> package can now optionally be given a promise for
such a value instead.</p>
<p>So this:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span><span class="op">$</span><span class="va">table</span> <span class="op">&lt;-</span> <span class="fu">renderTable</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="va">input</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>could become:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span><span class="op">$</span><span class="va">table</span> <span class="op">&lt;-</span> <span class="fu">renderTable</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="va">input</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>or, trading elegance for efficiency:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span><span class="op">$</span><span class="va">table</span> <span class="op">&lt;-</span> <span class="fu">renderTable</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">input_date</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">date</span></span>
<span>  <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="va">input_date</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The important thing to keep in mind is that the promise (or promise
pipeline) must be the final expression in the code block. Shiny only
knows about promises you actually return to it when you hand control
back.</p>
<div class="section level4">
<h4 id="render-functions-with-side-effects-renderprint-and-renderplot">Render functions with side effects: <code>renderPrint</code> and
<code>renderPlot</code><a class="anchor" aria-label="anchor" href="#render-functions-with-side-effects-renderprint-and-renderplot"></a>
</h4>
<p>The render functions <code>renderPrint()</code> and
<code>renderPlot()</code> are slightly different than other render
functions, in that they can be affected by side effects in the code
block you provide. In <code>renderPrint</code> you can print to the
console, and in <code>renderPlot</code> you can plot to the active R
graphics device.</p>
<p>With promises, these render functions can work in a similar way, but
with a caveat. As you hopefully understand by now, futures execute their
code in a separate R process, and printing/plotting in a separate
process won’t have any effect on the Shiny output in the original
process. These examples, then, are incorrect:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span><span class="op">$</span><span class="va">summary</span> <span class="op">&lt;-</span> <span class="fu">renderPrint</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">output</span><span class="op">$</span><span class="va">plot</span> <span class="op">&lt;-</span> <span class="fu">renderPlot</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">length</span>, <span class="va">width</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Instead, do printing and plotting after control returns back to the
original process, via a promise handler:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span><span class="op">$</span><span class="va">summary</span> <span class="op">&lt;-</span> <span class="fu">renderPrint</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">output</span><span class="op">$</span><span class="va">plot</span> <span class="op">&lt;-</span> <span class="fu">renderPlot</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="va">.</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">length</span>, <span class="va">width</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Again, you do need to be careful to make sure that the last
expression in your code block is the promise/pipeline; this is the only
way the rendering logic can know whether and when your logic has
completed, and if any errors occurred (so they can be displayed to the
user).</p>
</div>
</div>
<div class="section level3">
<h3 id="observers">Observers<a class="anchor" aria-label="anchor" href="#observers"></a>
</h3>
<p>Observers are very similar to outputs: you must make sure that the
last expression in your code block is the promise/pipeline. Like
outputs, observers need to know whether and when they’re done running,
and if any errors occured (so they can log them and terminate the user
session). The way to communicate this from your async user code is by
returning the promise.</p>
<p>Here’s a synchronous example that we’ll convert to async. Clicking
the <code>refresh_data</code> action button causes data to be
downloaded, which is then saved to disk as <code>cached.rds</code> and
also used to update the reactive value <code>data</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">reactiveVal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"cached.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">refresh_data</span>, <span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"cached.rds"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And the async version:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">reactiveVal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"cached.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">refresh_data</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"cached.rds"</span><span class="op">)</span></span>
<span>      <span class="va">df</span></span>
<span>    <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that in this version, we cannot call <code>data(df)</code>
inside the future, as this would cause the update to happen in the wrong
process. Instead, we use the <code>%...&gt;%</code> operator to perform
the assignment back in the main process once the future resolves.</p>
</div>
<div class="section level3">
<h3 id="reactive-expressions">Reactive expressions<a class="anchor" aria-label="anchor" href="#reactive-expressions"></a>
</h3>
<p>Recall that reactive expressions are used to calculate values, and
are cached until they are automatically invalidated by one of their
dependencies. Unlike outputs and observers, reactive expressions can be
used from other reactive consumers.</p>
<p>Asynchronous reactive expressions are similar to regular
(synchronous) reactive expressions: instead of a “normal” value, they
return a promise that will yield the desired value; and a normal
reactive will cache a normal value, while an async reactive will cache
the promise.</p>
<p>The upshot is that when defining an async reactive expression, your
code block should return a promise or promise pipeline, following the
same rules as reactive outputs. And when calling an async reactive
expression, call it like a function like you would a regular reactive
expression, and treat the value that’s returned like any other
promise.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">eventReactive</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">refresh_data</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">filteredData</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="va">input</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">table</span> <span class="op">&lt;-</span> <span class="fu">renderTable</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">filteredData</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And now in async:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">eventReactive</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">refresh_data</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/future_promise.html">future_promise</a></span><span class="op">(</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">filteredData</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="va">input</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">table</span> <span class="op">&lt;-</span> <span class="fu">renderTable</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">filteredData</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="the-flush-cycle">The flush cycle<a class="anchor" aria-label="anchor" href="#the-flush-cycle"></a>
</h2>
<p>In the past, Shiny’s reactive programming model has operated using a
mostly traditional <a href="https://en.wikipedia.org/wiki/Event_loop" class="external-link">event loop</a> model.
Somewhere many levels beneath <code>shiny::runApp()</code> was a piece
of code that looked a bit like this:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">while</span> <span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Do nothing until a browser sends some data</span></span>
<span>  <span class="va">input</span> <span class="op">&lt;-</span> <span class="fu">receiveInputFromBrowser</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co"># Use the received data to update reactive inputs</span></span>
<span>  <span class="va">session</span><span class="op">$</span><span class="fu">updateInput</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span>  <span class="co"># Execute all invalidated outputs/observers</span></span>
<span>  <span class="fu">flushReact</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co"># After ALL outputs execute, send the results back</span></span>
<span>  <span class="fu">flushOutputs</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We call this Shiny’s “flush cycle”. There are two important
properties to our flush cycle.</p>
<ol style="list-style-type: decimal">
<li>Only one of the four steps—receiving, updating, reacting, and
sending—can be executing a time. (Remember, R is single threaded.) In
particular, it’s not possible for inputs to be updated while
outputs/observers are running. This is important in order to avoid race
conditions that would be all but impossible to defend against.</li>
<li>Many outputs may change as a result of a single input value received
from the browser, but none of them are sent back to the client until all
of the outputs are ready. The advantage of this is a smoother experience
for the end-user in most cases. (Admittedly, there has been some
controversy regarding this property of Shiny; some app authors would
strongly prefer to show outputs as soon as they are ready, or at least
to have manual control over this behavior.)</li>
</ol>
<p>While adding async support to Shiny, we aimed to keep these two
properties intact. Imagine now that <code>flushReact()</code>, the line
that executes invalidated outputs/observers, returns a promise that
combines all of the async outputs/observers (i.e. a promise that
resolves only after all of the async outputs/observers have resolved).
The new, async-aware event loop is conceptually more like this:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doEventLoop</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Do nothing until a browser sends some data</span></span>
<span>  <span class="va">input</span> <span class="op">&lt;-</span> <span class="fu">receiveInputFromBrowser</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co"># Use the received data to update reactive inputs</span></span>
<span>  <span class="va">session</span><span class="op">$</span><span class="fu">updateInput</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span>  <span class="co"># Execute all invalidated outputs/observers</span></span>
<span>  <span class="fu">flushReact</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipes.html">%...&gt;%</a></span> <span class="op">{</span></span>
<span>    <span class="co"># After ALL outputs execute, send the results back</span></span>
<span>    <span class="fu">flushOutputs</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="co"># Continue the event loop</span></span>
<span>    <span class="fu">doEventLoop</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The resulting behavior matches the synchronous version of the event
loop, in that:</p>
<ol style="list-style-type: decimal">
<li>No inputs are received from the browser until all pending async
outputs/observers have completed. Unlike the synchronous version, this
separation is enforced at the session level: if Session A has some async
observers that have not finished executing, that only prevents Session A
from processing new input values, while new input values from Session B
can be handled immediately because they belong to a different session.
Again, the goal of keeping input updates separate from output/observer
execution is to prevent race conditions, which are even more pernicious
to debug and understand when async code is involved.</li>
<li>For a given session, no outputs are sent back to the client, until
all outputs are ready. It doesn’t matter whether the outputs in question
are synchronous, asynchronous, or some combination; they all must
complete execution before any can be sent.</li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Joe Cheng, Posit Software, PBC.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({


    apiKey: 'e02966c036b2b44dfdb6dede68b3b31b',
    indexName: 'rstudio',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
