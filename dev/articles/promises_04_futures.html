<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Launching tasks with future • promises</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Launching tasks with future">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">promises</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.3.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Learning

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/promises_01_motivation.html">1. Why use promises?</a>
    </li>
    <li>
      <a href="../articles/promises_02_intro.html">2. An informal intro to async programming</a>
    </li>
    <li>
      <a href="../articles/promises_03_overview.html">3. Working with promises</a>
    </li>
    <li>
      <a href="../articles/promises_04_futures.html">4. Launching tasks with future</a>
    </li>
    <li>
      <a href="../articles/promises_05_future_promise.html">5. Advanced future and promises usage</a>
    </li>
    <li>
      <a href="../articles/promises_06_shiny.html">6. Using promises with Shiny</a>
    </li>
    <li>
      <a href="../articles/promises_07_combining.html">7. Combining promises</a>
    </li>
    <li>
      <a href="../articles/promises_08_casestudy.html">8. Case study: Converting a Shiny app to async</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/promises/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>

    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Launching tasks with future</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/promises/blob/main/vignettes/promises_04_futures.Rmd" class="external-link"><code>vignettes/promises_04_futures.Rmd</code></a></small>
      <div class="hidden name"><code>promises_04_futures.Rmd</code></div>

    </div>

    
    
<p>The <code>future</code> package provides a lightweight way to launch
R tasks that don’t block the current R session. It was created by Henrik
Bengtsson long before the <code>promises</code> package existed—the
first CRAN release of <code>future</code> predates development of
<code>promises</code> by almost two years.</p>
<p>The <code>promises</code> package provides the API for working with
the results of async tasks, but it totally abdicates responsibility for
actually launching/creating async tasks. The idea is that any number of
different packages could be capable of launching async tasks, using
whatever techniques they want, but all of them would either return
promise objects (or objects that can be converted to promise objects, as
is the case for <code>future</code>). However, for now,
<code>future</code> is likely to be the primary or even exclusive way
that async tasks are created.</p>
<p>This document will give an introduction to the parts of
<code>future</code> that are most relevant to promises. For more
information, please consult the vignettes that come with
<code>future</code>, especially the <a href="https://CRAN.R-project.org/package=future/vignettes/future-1-overview.html" class="external-link">Comprehensive
Overview</a>.</p>
<div class="section level2">
<h2 id="how-future-works">How future works<a class="anchor" aria-label="anchor" href="#how-future-works"></a>
</h2>
<p>The main API that <code>future</code> provides couldn’t be simpler.
You call <code><a href="https://future.futureverse.org/reference/future.html" class="external-link">future()</a></code> and pass it the code that you want
executed asynchronously:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://future.futureverse.org/reference/future.html" class="external-link">future</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># expensive operations go here...</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">download_lots_of_data</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">fit_model</span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The object that’s returned is a future, which for all intents and
purposes is a promise object<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>, which will eventually resolve to the
return value of the code block (i.e. the last expression) or an error if
the code does not complete executing successfully. The important thing
is that no matter how long the expensive operation takes, these lines
will execute almost instantly, while the operation continues in the
background.</p>
<p>But we know that R is single-threaded, so how does
<code>future</code> accomplish this? The answer: by utilizing another R
process. <code>future</code> delegates the execution of the expensive
operation to a totally different R process, so that the original R
process can move on.</p>
</div>
<div class="section level2">
<h2 id="choosing-a-launch-method">Choosing a launch method<a class="anchor" aria-label="anchor" href="#choosing-a-launch-method"></a>
</h2>
<p>There are several different methods we could use for launching R
processes or attaching to existing R processes, and each method has its
own advantages, disadvantages, limitations, and requirements. Rather
than prescribing a single method, the <code>future</code> package
provides an extensible mechanism that lets you, the R user, decide what
method to use. Call the <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code> function with one of the
following values (without quotes—these are function names, not
strings):</p>
<ul>
<li>
<code>multisession</code>: Launches up to <em>n</em> background R
processes on the same machine (where <em>n</em> is the number of
processor cores on the system, minus 1). These background processes will
be used/recycled for the life of the originating R process. If a future
is launched while all the background R processes are busy executing,
then the new future will be queued until one of the background processes
free up.</li>
<li>
<code>multicore</code>: Each new task executes in its own forked
child process. Forking is generally much faster than launching a new
process from scratch, and most of the state of the original process is
available to the child process without having to go through any extra
effort (see the section about Globals below). The biggest limitation of
forking is that it doesn’t work at all on Windows operating systems,
which is what the majority of R users use. There are also some dangerous
edge cases with this style of execution (Google “fork without exec” for
more information), though popular frameworks like RServe and OpenCPU
rely heavily on this and don’t seem to suffer for it.</li>
</ul>
<p>The <code>future</code> package also includes a
<code>sequential</code> method, which executes synchronously and is
therefore not relevant for our purposes. Unfortunately,
<code>sequential</code> is the default, hence explicitly calling
<code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code> with a different method is a must.</p>
<p>There is also a <code>cluster</code> method, as well as a separate
<code>future.batchtools</code> package, for doing distributed execution;
those may work with promises, but have not been tested by our team and
are not described further in this document.</p>
<p>To learn more, see the <a href="https://future.futureverse.org/reference/plan.html" class="external-link"><code>future::plan()</code>
reference docs</a> as well as the <a href="https://future.futureverse.org/articles/future-1-overview.html#controlling-how-futures-are-resolved" class="external-link"><code>future</code>
overview</a>.</p>
</div>
<div class="section level2">
<h2 id="caveats-and-limitations">Caveats and limitations<a class="anchor" aria-label="anchor" href="#caveats-and-limitations"></a>
</h2>
<p>The abstractions that <code>future</code> presents are simple, but <a href="https://en.wikipedia.org/wiki/Leaky_abstraction" class="external-link">leaky</a>. You
can’t make effective use of <code>future</code> without understanding
its various strategies for running R tasks asynchronously. Please read
this entire section carefully before proceeding.</p>
<div class="section level3">
<h3 id="globals-providing-input-to-future-code-chunks">Globals: Providing input to future code chunks<a class="anchor" aria-label="anchor" href="#globals-providing-input-to-future-code-chunks"></a>
</h3>
<p>Most future code chunks will need to reference data from the original
process, e.g. data to be fitted, URLs to be requested, file paths to
read from. The future package goes to some lengths to try to make this
process seamless for you, by inspecting your code chunk and predicting
which variables from the original process should be copied to the child
process. In our testing this works fairly reliably with multicore,
somewhat less reliably with multisession.</p>
<p>Multisession also has the distinct disadvantage that any identified
variables must be physically (though automatically) copied between the
main and child processes, which can be extremely time-consuming if the
data is large. (The multicore strategy does not need to do this, because
every forked process starts out with its memory in the same state as its
parent at the time of the fork.)</p>
<p>In summary, it’s possible for both false positives (data copied that
doesn’t need to be) and false negatives (data not available when it’s
needed) to occur. Therefore, for all but the simplest cases, we suggest
suppressing future’s automated variable copying and instead manually
specifying the relevant variables, using the <code><a href="https://future.futureverse.org/reference/future.html" class="external-link">future()</a></code>
function’s <code>globals</code> parameter. You can pass it a character
vector (<code>globals = c("var_a", "var_b")</code>) or a named list
(<code>globals = c(data = mtcars, iterations = n)</code>).</p>
<p>One final note about globals: as a safety measure,
<code><a href="https://future.futureverse.org/reference/future.html" class="external-link">future()</a></code> will error if the size of the data to be shuttled
between the processes exceeds 500MB. This is true whether the variables
to copy were identified by automatic detection, or explicitly via the
<code>globals</code> parameter; and it’s even true if you’re using the
multicore strategy, where no copies are actually made. If your data is
potentially large, you’ll want to increase the limit by setting the
<code>future.globals.maxSize</code> option to a suitably high number of
bytes, e.g. <code>options(future.globals.maxSize=1e9)</code> for a
billion bytes.</p>
</div>
<div class="section level3">
<h3 id="package-loading">Package loading<a class="anchor" aria-label="anchor" href="#package-loading"></a>
</h3>
<p>Besides variables, <code><a href="https://future.futureverse.org/reference/future.html" class="external-link">future()</a></code> also tries to automatically
infer what R packages need to be loaded in the child process. If the
automatic detection is not sufficient, you can use the
<code><a href="https://future.futureverse.org/reference/future.html" class="external-link">future()</a></code> function’s <code>packages</code> parameter to pass
in a character vector of package names,
e.g. <code>packages = c("dplyr", "ggplot2")</code>.</p>
<p>Again, this is especially important for multisession, because
multicore will inherit all of the attached packages of the parent
process.</p>
</div>
<div class="section level3">
<h3 id="native-resources">Native resources<a class="anchor" aria-label="anchor" href="#native-resources"></a>
</h3>
<p>Future code blocks cannot use resources such as database connections
and network sockets that were created in the parent process. This is
true regardless of what future implementation you use! Even if it seems
to work with a simple test, you are asking for crashes or worse by
sharing these kinds of resources across processes.</p>
<p>Instead, make sure you create, use, and destroy such resources
entirely within the scope of the future code block.</p>
</div>
<div class="section level3">
<h3 id="mutation">Mutation<a class="anchor" aria-label="anchor" href="#mutation"></a>
</h3>
<p>Reference class objects (including R6 objects and data.table objects)
and environments are among the few “native” R object types that are
mutable, that is, can be modified in-place. Unless they contain native
resources (see previous section), there’s nothing wrong with using
mutable objects from within future code blocks, even objects created in
the parent process. However, note that any changes you make to these
objects will not be visible from the parent process; the future code is
operating on a copy of the object, not the original.</p>
</div>
<div class="section level3">
<h3 id="returning-values">Returning values<a class="anchor" aria-label="anchor" href="#returning-values"></a>
</h3>
<p>Future code blocks can return a value—they’d be a lot less useful if
they couldn’t! Like everywhere else in R, the return value is determined
by the last expression in the code block, unless <code><a href="https://rdrr.io/r/base/function.html" class="external-link">return()</a></code>
is explicitly called earlier.</p>
<p>Regardless of future method, the return value will be copied back
into the parent process. This matters for two reasons.</p>
<p>First, if the return value is very large, the copying process can
take some time—and because the data must essentially be serialized to
and deserialized from rds format, it can take a surprising amount of
time. In the case of future blocks that execute fairly quickly but
return huge amounts of data, you may be better off not using
future/async techniques at all.</p>
<p>Second, objects that refer to native resources are unlikely to work
in this direction either; just as you can’t use the parent’s database
connections in the child process, you also cannot have the child process
return a database connection for the parent to use.</p>
<div style="display:flex;">
<div style="font-size: 20px; margin-top: 40px; margin-left: auto;">
<p>Next:</p>
<ul>
<li><p><a href="promises_05_future_promise.html">Advanced
<code>future</code> and <code>promises</code> usage</a></p></li>
<li>
<p><a href="promises_06_shiny.html">Using <code>promises</code> with
Shiny</a></p>
</li>
</ul>
</div>

</div>
</div>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>(The <code>future</code> package provides several
functions for working with future objects, but they are not relevant for
our purposes.)<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Joe Cheng, Posit Software, PBC.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({


    apiKey: 'e02966c036b2b44dfdb6dede68b3b31b',
    indexName: 'rstudio',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
