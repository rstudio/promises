<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Case study: converting a Shiny app to async • promises</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Nunito-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Case study: converting a Shiny app to async">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">promises</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.4.0.9001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Overview</h6></li>
    <li><a class="dropdown-item" href="../articles/promises_01_motivation.html">1. Why use promises?</a></li>
    <li><a class="dropdown-item" href="../articles/promises_02_intro.html">2. An informal intro to async programming</a></li>
    <li><a class="dropdown-item" href="../articles/promises_03_overview.html">3. Working with promises</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Integration</h6></li>
    <li><a class="dropdown-item" href="../articles/promises_04_mirai.html">4. Launching tasks with mirai</a></li>
    <li><a class="dropdown-item" href="../articles/promises_05a_futures.html">5a. Launching tasks with future</a></li>
    <li><a class="dropdown-item" href="../articles/promises_05b_future_promise.html">5b. Advanced future and promises usage</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Usage</h6></li>
    <li><a class="dropdown-item" href="../articles/promises_06_shiny.html">6. Using promises with Shiny</a></li>
    <li><a class="dropdown-item" href="../articles/promises_07_combining.html">7. Combining promises</a></li>
    <li><a class="dropdown-item" href="../articles/promises_08_casestudy.html">8. Case study: Converting a Shiny app to async</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rstudio/promises/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Case study: converting a Shiny app to async</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/promises/blob/main/vignettes/promises_08_casestudy.Rmd" class="external-link"><code>vignettes/promises_08_casestudy.Rmd</code></a></small>
      <div class="d-none name"><code>promises_08_casestudy.Rmd</code></div>
    </div>

    
    
<p>In this case study, we’ll work through an application of reasonable
complexity, turning its slowest operations into mirai/promises and
modifying all the downstream reactive expressions and outputs to deal
with promises.</p>
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<blockquote>
<p>As a web service increases in popularity, so does the number of rogue
scripts that abuse it for no apparent reason.</p>
<p><em>—Joe Cheng’s Law of Why We Can’t Have Nice Things</em></p>
</blockquote>
<p>I first noticed this in 2011, when the then-new RStudio IDE was
starting to gather steam. We had a dashboard that tracked how often
RStudio was being downloaded, and the numbers were generally tracking
smoothly upward. But once every few months, we’d have huge spikes in the
download counts, ten times greater than normal—and invariably, we’d find
that all of the unexpected increase could be tracked to one or two IP
addresses.</p>
<p>For hours or days we’d be inundated with thousands of downloads per
hour, then just as suddenly, they’d cease. I didn’t know what was
happening then, and I still don’t know today. Was it the world’s least
competent denial-of-service attempt? Did someone write a download script
with an accidental <code>while (TRUE)</code> around it?</p>
<p>Our application will let us examine downloads from CRAN for this kind
of behavior. For any given day on CRAN, we’ll see what the top
downloaders are and how they’re behaving.</p>
</div>
<div class="section level2">
<h2 id="our-source-data">Our source data<a class="anchor" aria-label="anchor" href="#our-source-data"></a>
</h2>
<p>RStudio maintains the popular <code>0-Cloud</code> CRAN mirror, and
the log files it generates are freely available at <a href="http://cran-logs.rstudio.com/" class="external-link uri">http://cran-logs.rstudio.com/</a>. Each day is a separate
gzipped CSV file, and each row is a single package download. For
privacy, IP addresses are anonymized by substituting each day’s IP
addresses with unique integer IDs.</p>
<p>Here are the first few lines of <a href="http://cran-logs.rstudio.com/2018/2018-05-26.csv.gz" class="external-link uri">http://cran-logs.rstudio.com/2018/2018-05-26.csv.gz</a>
:</p>
<pre><code>"date","time","size","r_version","r_arch","r_os","package","version","country","ip_id"
"2018-05-26","20:42:23",450377,"3.4.4","x86_64","linux-gnu","lubridate","1.7.4","NL",1
"2018-05-26","20:42:30",484348,NA,NA,NA,"homals","0.9-7","GB",2
"2018-05-26","20:42:21",98484,"3.3.1","x86_64","darwin13.4.0","miniUI","0.1.1.1","NL",1
"2018-05-26","20:42:27",518,"3.4.4","x86_64","linux-gnu","RCurl","1.95-4.10","US",3</code></pre>
<p>Fortunately for our purposes, there’s no need to analyze these logs
at a high level to figure out which days are affected by badly behaved
download scripts. These CRAN mirrors are popular enough that, according
to Cheng’s Law, there should be plenty of rogue scripts hitting it every
day of the year.</p>
</div>
<div class="section level2">
<h2 id="a-tour-of-the-app">A tour of the app<a class="anchor" aria-label="anchor" href="#a-tour-of-the-app"></a>
</h2>
<p>The app I built to explore this data, <strong>cranwhales</strong>,
let us examine the behavior of the top downloaders (“whales”) for any
given day, at varying levels of detail. You can view this app live at <a href="https://gallery.shinyapps.io/cranwhales/" class="external-link uri">https://gallery.shinyapps.io/cranwhales/</a>, or download
and run the code yourself at <a href="https://github.com/rstudio/cranwhales" class="external-link uri">https://github.com/rstudio/cranwhales</a>.</p>
<p>When the app starts, the “All traffic” tab shows you the number of
package downloads per hour for all users vs. whales. In this screenshot,
you can see the proportion of files downloaded by the top six
downloaders on May 28, 2018. It may not look like a huge fraction at
first, but keep in mind, we are only talking about six downloaders out
of 52,815 total!</p>
<div class="float">
<img src="case-study-tab1.png" alt="“All traffic” app tab displaying histogram of top six downloaders."><div class="figcaption">“All traffic” app tab displaying histogram of
top six downloaders.</div>
</div>
<p>The “Biggest whales” tab simply shows the most prolific downloaders,
with their number of downloads performed. Each anonymized IP address has
been assigned an easier-to-remember name, and you can also see the
country code of the original IP address.</p>
<div class="float">
<img src="case-study-tab2.png" alt="“Biggest whales” app tab displays excessive download counts for top 6 downloaders."><div class="figcaption">“Biggest whales” app tab displays excessive
download counts for top 6 downloaders.</div>
</div>
<p>The “Whales by hour” tab shows the hourly download counts for each
whale individually. In this screenshot, you can see that the
Netherlands’ <code>relieved_snake</code> downloaded at an extremely
consistent rate during the whole day, while the American
<code>curly_capabara</code> was active only during business hours in
Eastern Standard Time. Still others, like <code>colossal_chicken</code>
out of Hong Kong, was busy all day but at varying rates.</p>
<div class="float">
<img src="case-study-tab3.png" alt="“Whales by hour” app tab shows hourly pattern of each whale."><div class="figcaption">“Whales by hour” app tab shows hourly pattern of
each <em>whale</em>.</div>
</div>
<p>The “Detail View” has perhaps the most illuminating information. It
lets you view every download made by a given whale on the day in
question. The x dimension is time and the y dimension is what package
they downloaded, so you can see at a glance exactly how many packages
were downloaded, and how their various package downloads relate to each
other. In this case, <code>relieved_snake</code> downloaded 104
different packages, in the same order, continuously, for the entire
day.</p>
<div class="float">
<img src="case-study-tab4.png" alt="“Detail View” showing how relieved_snake downloads 104 packages continuously all day long."><div class="figcaption">“Detail View” showing how
<code>relieved_snake</code> downloads 104 packages continuously all day
long.</div>
</div>
<p>Others behave very differently, like <code>freezing_tapir</code>, who
downloaded <code>devtools</code>–and <em>only</em>
<code>devtools</code>–for the whole day, racking up 19,180 downloads
totalling 7.9 gigabytes for that one package alone!</p>
<div class="float">
<img src="case-study-tab5.png" alt="“Detail View” showing how freezing_tapir only downloads {devtools} continuously all day long."><div class="figcaption">“Detail View” showing how
<code>freezing_tapir</code> only downloads <a href="https://devtools.r-lib.org/" class="external-link">devtools</a>
continuously all day long.</div>
</div>
<p>Sadly, the app can’t tell us any more than that–it can’t explain
<em>why</em> these downloaders are behaving this way, nor can it tell us
their street addresses so that we can send ninjas in black RStudio
helicopters to make them stop.</p>
</div>
<div class="section level2">
<h2 id="the-implementation">The implementation<a class="anchor" aria-label="anchor" href="#the-implementation"></a>
</h2>
<p>Now that you’ve seen what the app does, let’s talk about how it was
implemented, then convert it from sync to async.</p>
<div class="section level3">
<h3 id="user-interface">User interface<a class="anchor" aria-label="anchor" href="#user-interface"></a>
</h3>
<p>The user interface is a pretty typical shinydashboard. It’s important
to note that the UI part of the app is entirely agnostic to whether the
server is written in the sync or async style; when we port the app to
async, we won’t touch the UI at all.</p>
<p>There are two major pieces of input we need from users: what
<strong>date</strong> to examine (this app only lets us look at one day
at a time) and <strong>how many</strong> of the most prolific
downloaders to look at. We’ll put these two controls in the dashboard
sidebar.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dashboardSidebar</span><span class="op">(</span></span>
<span>  <span class="fu">dateInput</span><span class="op">(</span><span class="st">"date"</span>, <span class="st">"Date"</span>, value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu">numericInput</span><span class="op">(</span><span class="st">"count"</span>, <span class="st">"Show top N downloaders:"</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>(We set <code>date</code> to two days ago by default, because there’s
some lag between when a day ends and when its logs are published.)</p>
<p>The rest of the UI code is just typical shinydashboard scaffolding,
plus some <code>shinydashboard::valueBoxOutput</code>s and
<code>plotOutputs</code>. These are so trivial that they’re hardly worth
talking about, but I’ll include the code here for completeness. Finally,
there’s <code>detailViewUI</code>, a <a href="https://shiny.posit.co/r/articles/improve/modules/" class="external-link">Shiny
module</a> that just contains more of the same (value boxes and
plots).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu">dashboardBody</span><span class="op">(</span></span>
<span>    <span class="fu">fluidRow</span><span class="op">(</span></span>
<span>      <span class="fu">tabBox</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">12</span>,</span>
<span>        <span class="fu">tabPanel</span><span class="op">(</span><span class="st">"All traffic"</span>,</span>
<span>          <span class="fu">fluidRow</span><span class="op">(</span></span>
<span>            <span class="fu">valueBoxOutput</span><span class="op">(</span><span class="st">"total_size"</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>            <span class="fu">valueBoxOutput</span><span class="op">(</span><span class="st">"total_count"</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>            <span class="fu">valueBoxOutput</span><span class="op">(</span><span class="st">"total_downloaders"</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span>          <span class="op">)</span>,</span>
<span>          <span class="fu">plotOutput</span><span class="op">(</span><span class="st">"all_hour"</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu">tabPanel</span><span class="op">(</span><span class="st">"Biggest whales"</span>,</span>
<span>          <span class="fu">plotOutput</span><span class="op">(</span><span class="st">"downloaders"</span>, height <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu">tabPanel</span><span class="op">(</span><span class="st">"Whales by hour"</span>,</span>
<span>          <span class="fu">plotOutput</span><span class="op">(</span><span class="st">"downloaders_hour"</span>, height <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu">tabPanel</span><span class="op">(</span><span class="st">"Detail view"</span>,</span>
<span>          <span class="fu">detailViewUI</span><span class="op">(</span><span class="st">"details"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="server-logic">Server logic<a class="anchor" aria-label="anchor" href="#server-logic"></a>
</h3>
<p>Based on these inputs and outputs, we’ll write a variety of reactive
expressions and output renderers to download, manipulate, and visualize
the relevant log data.</p>
<p>The reactive expressions:</p>
<ul>
<li>
<code>data</code> (<code>eventReactive</code>): Whenever
<code>input$date</code> changes, the <code>data</code> reactive
downloads the full log for that day from <a href="http://cran-logs.rstudio.com" class="external-link uri">http://cran-logs.rstudio.com</a>, and parses it.</li>
<li>
<code>whales</code> (<code>reactive</code>): Reads from
<code><a href="https://rdrr.io/r/utils/data.html" class="external-link">data()</a></code>, tallies the number of downloads performed by each
unique IP, and returns a data frame of the top <code>input$count</code>
most prolific downloaders, along with their download counts.</li>
<li>
<code>whale_downloads</code> (<code>reactive</code>): Joins the
<code><a href="https://rdrr.io/r/utils/data.html" class="external-link">data()</a></code> and <code>whales()</code> data frames, to return all
of the details of the cetacean downloads.</li>
</ul>
<p>The <code>whales</code> reactive expression depends on
<code>data</code>, and <code>whale_downloads</code> depends on
<code>data</code> and <code>whales</code>.</p>
<div class="float">
<img src="case-study-react.png" alt="Reactive dependencies of an application."><div class="figcaption">Reactive dependencies of an application.</div>
</div>
<p>The outputs in this app are mostly either <code>renderPlot</code>s
that we populate with <code>ggplot2</code>, or
<code>shinydashboard::renderValueBox</code>es. They all rely on one or
more of the reactive expressions we just described. We won’t catalog
them all here, as they’re not individually interesting, but we will look
at some archetypes below.</p>
</div>
</div>
<div class="section level2">
<h2 id="improving-performance-and-scalability">Improving performance and scalability<a class="anchor" aria-label="anchor" href="#improving-performance-and-scalability"></a>
</h2>
<p>While this article is specifically about async, this is a good time
to remind you that there are lots of ways to improve the performance of
a Shiny app. Async is just one tool in the toolbox, and before reaching
for that hammer, take a moment to consider your other options:</p>
<ol style="list-style-type: decimal">
<li>Have I used <a href="https://profvis.r-lib.org/" class="external-link">profvis</a> to
<strong>profile my code</strong> and determine what’s actually taking so
long? (Human intuition is a notoriously bad profiler!)</li>
<li>Can I perform any <strong>calculations, summarizations, and
aggregations offline</strong>, when my Shiny app isn’t even running, and
save the results to .rds files to be read by the app?</li>
<li>Are there any opportunities to <strong>cache</strong>–that is, save
the results of my calculations and use them if I get the same request
later? (See <a href="https://cran.r-project.org/package=memoise" class="external-link">memoise</a>, or roll
your own.)</li>
<li>Am I effectively leveraging <a href="https://posit.co/resources/videos/reactivity-pt-1-joe-cheng/" class="external-link">reactive
programming</a> to make sure my reactives are doing as little work as
possible?</li>
<li>When deploying my app, am I load balancing across multiple R
processes and/or multiple servers? (<a href="https://docs.posit.co/shiny-server/" class="external-link">Shiny Server Pro</a>, <a href="https://docs.posit.co/connect/admin/appendix/configuration/" class="external-link">RStudio
Connect</a>, <a href="https://shiny.posit.co/r/articles/improve/scaling-and-tuning/" class="external-link">ShinyApps.io</a>)</li>
</ol>
<p>These options are more generally useful than using async techniques
because they can dramatically speed up the performance of an app even if
only a single user is using it. While it obviously depends on the
particulars of the app itself, a few lines of precomputation or caching
logic can often lead to 10X-100X better performance. Async, on the other
hand, generally doesn’t help make a single session faster. Instead, it
helps a single Shiny process support more concurrent sessions without
getting bogged down.</p>
<p>Async can be an essential tool when there is no way around performing
expensive tasks (i.e. taking multiple seconds) while the user waits. For
example, an app that analyzes any user-specified Twitter profile may get
too many unique queries (assuming most people specify their own Twitter
handle) for caching to be much help. And applications that invite users
to upload their own datasets won’t have an opportunity to do any offline
summarizing in advance. If you need to run apps like that and support
lots of concurrent users, async can be a huge help.</p>
<p>In that sense, the cranwhales app isn’t a perfect example, because it
has lots of opportunities for precomputation and caching that we’ll
willfully ignore today so that I can better illustrate the points I want
to make about async. When you’re working on your own app, though, please
think carefully about <em>all</em> of the different techniques you have
for improving performance.</p>
</div>
<div class="section level2">
<h2 id="converting-to-async">Converting to async<a class="anchor" aria-label="anchor" href="#converting-to-async"></a>
</h2>
<p>To quote the article <a href="https://rstudio.github.io/promises/articles/promises_06_shiny.html"><em>Using
promises with Shiny</em></a>, async programming with Shiny boils down to
following a few steps:</p>
<ol style="list-style-type: decimal">
<li>Identify slow operations in your app.</li>
<li>Convert the slow operations into mirai.</li>
<li>Any code that relies on the result of those operations (if any),
whether directly or indirectly, now must be converted to promise
handlers that operate on the mirai object.</li>
</ol>
<p>In this case, the slow operations are easy to identify: the
downloading and parsing that takes place in the <code>data</code>
reactive expression can each take several long seconds.</p>
<p>Converting the download and parsing operations into mirai turns out
to be the most complicated part of the process, for reasons we’ll get
into later.</p>
<p>Assuming we do that successfully, the <code>data</code> reactive
expression will no longer return a data frame, but a
<code>promise</code> object (that resolves to a data frame). Since the
<code>whales</code> and <code>whale_downloads</code> reactive
expressions both rely on <code>data</code>, those will both also need to
be converted to read and return <code>promise</code> objects. And
therefore, because the outputs all rely on one or more reactive
expressions, they will all need to know how to deal with
<code>promise</code> objects.</p>
<p>Async code is infectious like that; once you turn the heart of your
app into a promise, everything downstream must become promise-aware as
well, all the way through to the observers and outputs.</p>
<p>With that overview out of the way, let’s dive into the code.</p>
<p>In the sections below, we’ll take a look at the code behind some
outputs and reactive expressions. For each element, we’ll look first at
the sync version, then the async version.</p>
<p>In some cases, these code snippets may be slightly abridged. See the
<a href="https://github.com/rstudio/cranwhales" class="external-link">GitHub repository</a>
for the full code.</p>
<p>Until you’ve received an introduction to
<code>lhs |&gt; then(func)</code> chaining, the async code below will
make no sense, so if you haven’t read <a href="https://rstudio.github.io/promises/articles/promises_02_intro.html"><em>An
informal intro to async programming</em></a> and/or <a href="https://rstudio.github.io/promises/articles/promises_03_overview.html"><em>Working
with promises in R</em></a>, I highly recommend doing so before
continuing!</p>
<div class="section level3">
<h3 id="loading-promises-and-mirai">Loading <code>promises</code> and <code>mirai</code><a class="anchor" aria-label="anchor" href="#loading-promises-and-mirai"></a>
</h3>
<p>The first thing we’ll do is load the basic libraries of async
programming.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/promises/">promises</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mirai.r-lib.org" class="external-link">mirai</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">daemons</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p>The above sets 6 daemons (background processes) on the local machine,
but this could also be anything else supported by the
<code><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">daemons()</a></code> function.</p>
</div>
<div class="section level3">
<h3 id="the-data-reactive-mirai-all-the-things">The <code>data</code> reactive: mirai() all the things<a class="anchor" aria-label="anchor" href="#the-data-reactive-mirai-all-the-things"></a>
</h3>
<p>The next thing we’ll do is convert the <code>data</code> event
reactive to use <code>mirai</code> for the expensive bits. The original
code looks lke this:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># SYNCHRONOUS version</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">eventReactive</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span>, <span class="op">{</span></span>
<span>  <span class="va">date</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">date</span>  <span class="co"># Example: 2018-05-28</span></span>
<span>  <span class="va">year</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu">year</span><span class="op">(</span><span class="va">date</span><span class="op">)</span>  <span class="co"># Example: "2018"</span></span>
<span></span>
<span>  <span class="va">url</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"http://cran-logs.rstudio.com/{year}/{date}.csv.gz"</span><span class="op">)</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"data_cache"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">".csv.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">withProgress</span><span class="op">(</span>value <span class="op">=</span> <span class="cn">NULL</span>, <span class="op">{</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">setProgress</span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Downloading data..."</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="va">url</span>, <span class="va">path</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu">setProgress</span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Parsing data..."</span><span class="op">)</span></span>
<span>    <span class="fu">read_csv</span><span class="op">(</span><span class="va">path</span>, col_types <span class="op">=</span> <span class="st">"Dti---c-ci"</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>(Earlier, I said we wouldn’t take advantage of precomputation or
caching. That wasn’t entirely true; in the code above, we cache the log
files we download in a <code>data_cache</code> directory. I couldn’t
bring myself to put my internet connection through that level of abuse,
as I knew I’d be running this code thousands of times as I load tested
it.)</p>
<p>For now, we’ll lose the
<code>withProgress</code>/<code>setProgress</code> reporting, since
doing that correctly requires some more advanced techniques that we’ll
talk about later. We’ll come back and fix this code later, but for
now:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ASYNCHRONOUS version</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">eventReactive</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span>, <span class="op">{</span></span>
<span>  <span class="va">date</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">date</span></span>
<span>  <span class="va">year</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu">year</span><span class="op">(</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">url</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"http://cran-logs.rstudio.com/{year}/{date}.csv.gz"</span><span class="op">)</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"data_cache"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">".csv.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="va">url</span>, <span class="va">path</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="fu">read_csv</span><span class="op">(</span><span class="va">path</span>, col_types <span class="op">=</span> <span class="st">"Dti---c-ci"</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    path <span class="op">=</span> <span class="va">path</span>,</span>
<span>    url <span class="op">=</span> <span class="va">url</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Pretty straightforward. This reactive now returns a mirai (which
counts as a promise), not a data frame.</p>
<p>Remember that we <strong>must</strong> read any reactive values
(including <code>input</code>) and reactive expressions <a href="https://rstudio.github.io/promises/articles/promises_06_shiny.html#shiny-specific-caveats-and-limitations">from
<strong>outside</strong> the mirai</a>. (You will get an error if you
attempt to read one from inside the mirai.)</p>
<p>At this point, since there are no other long-running operations we
want to make asynchronous, we’re actually done interacting directly with
the <code>mirai</code> package. The rest of the reactive expressions
will deal with the mirai returned by <code>data</code> using general
async functions and operators from <code>promises</code>.</p>
</div>
<div class="section level3">
<h3 id="the-whales-reactive-simple-pipelines-are-simple">The <code>whales</code> reactive: simple pipelines are simple<a class="anchor" aria-label="anchor" href="#the-whales-reactive-simple-pipelines-are-simple"></a>
</h3>
<p>The <code>whales</code> reactive takes the data frame from
<code>data</code>, and uses dplyr to find the top
<code>input$count</code> most prolific downloaders.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># SYNCHRONOUS version</span></span>
<span></span>
<span><span class="va">whales</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">count</span><span class="op">(</span><span class="va">ip_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">count</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Since <code><a href="https://rdrr.io/r/utils/data.html" class="external-link">data()</a></code> now returns a promise, the whole function
needs to be modified to deal with promises.</p>
<p>This is basically a best-case scenario for working with
<code>promises</code>. The whole expression consists of native pipes.
There’s only one object (<code><a href="https://rdrr.io/r/utils/data.html" class="external-link">data()</a></code>) that’s been converted to a
promise. The promise object only appears once, at the head of the
pipeline.</p>
<p>When the stars align like this, converting this code to async is
literally as easy as wrapping each line in an anonymous function inside
<code><a href="../reference/then.html">then()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ASYNCHRONOUS version</span></span>
<span></span>
<span><span class="va">whales</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu">count</span><span class="op">(</span><span class="va">ip_id</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The input (<code><a href="https://rdrr.io/r/utils/data.html" class="external-link">data()</a></code>) is a promise, the resulting output
object is a promise, each stage of the pipeline returns a promise; but
we can read and write this code almost as easily as the synchronous
version!</p>
<p>An example this simple may seem reductive, but this best-case
scenario happens surprisingly often, if your coding style is influenced
by the tidyverse. In this example app, <strong>59%</strong> of the
reactives, observers, and outputs were converted using nothing more than
replacing <code>|&gt;</code> with <code><a href="../reference/then.html">then()</a></code>.</p>
<p>One last thing before we move on. In the last section, I emphasized
that reactive values cannot be read from inside a mirai. Here, we’re
using <code>head(input$count)</code> inside a promise-pipeline; since
<code><a href="https://rdrr.io/r/utils/data.html" class="external-link">data()</a></code> is written using a mirai, doesn’t that mean… well…
isn’t this wrong?</p>
<p>Nope—this code is just fine. The prohibition is against reading
reactive values/expressions from <em>inside</em> a mirai, because code
inside a mirai is executed in a totally different R process. The steps
in a promise-pipeline are not mirai, but promise handlers. These aren’t
executed in a different process; rather, they’re executed back in the
original R process after a promise is resolved. We’re allowed and
expected to access reactive values and expressions from these
handlers.</p>
</div>
<div class="section level3">
<h3 id="the-whale_downloads-reactive-reading-from-multiple-promises">The <code>whale_downloads</code> reactive: reading from multiple
promises<a class="anchor" aria-label="anchor" href="#the-whale_downloads-reactive-reading-from-multiple-promises"></a>
</h3>
<p>The <code>whale_downloads</code> reactive is a bit more complicated
case.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># SYNCHRONOUS version</span></span>
<span></span>
<span><span class="va">whale_downloads</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">inner_join</span><span class="op">(</span><span class="fu">whales</span><span class="op">(</span><span class="op">)</span>, <span class="st">"ip_id"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Looks simple, but we can’t just do a simple replacement this time.
Can you see why?</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># BAD VERSION DOESN'T WORK</span></span>
<span></span>
<span><span class="va">whale_downloads</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu">inner_join</span><span class="op">(</span><span class="fu">whales</span><span class="op">(</span><span class="op">)</span>, <span class="st">"ip_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Remember, both <code><a href="https://rdrr.io/r/utils/data.html" class="external-link">data()</a></code> and <code>whales()</code> now
return a promise object, not a data frame. None of the dplyr verbs know
how to deal with promises natively (and the same is true for almost
every other R function, anywhere in the R universe).</p>
<p>We’re able to use <code><a href="../reference/then.html">then()</a></code> with promises on the left-hand
side and regular dplyr calls on the right-hand side, only because the
<code><a href="../reference/then.html">then()</a></code> operator “unwraps” the promise object for us,
yielding a regular object (data frame or whatever) to be passed to
dplyr. But in this case, we’re passing <code>whales()</code>, which a
promise object, directly to <code>inner_join</code>, and
<code>inner_join</code> has no idea what to do with it.</p>
<p>The fundamental thing to pattern-match on here, is that <strong>we
have a block of code that relies on more than one promise
object</strong>, and that means <code><a href="../reference/then.html">then()</a></code> won’t be enough.
This is a pretty common situation as well, and occurs in
<strong>12%</strong> of reactives and outputs in this example app.</p>
<p>Here’s what the real solution looks like:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># ASYNCHRONOUS version</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>whale_downloads <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="fu">promise_all</span>(<span class="at">data_df =</span> <span class="fu">data</span>(), <span class="at">whales_df =</span> <span class="fu">whales</span>()) <span class="sc">|&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    <span class="fu">then</span>(\(values) {</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>      <span class="fu">with</span>(values, {</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>        data_df <span class="sc">|&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>          <span class="fu">inner_join</span>(whales_df, <span class="st">"ip_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>          <span class="fu">select</span>(<span class="sc">-</span>n)</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>      })</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    })</span></code></pre></div>
<div class="section level4">
<h4 id="promises-the-gathering">Promises: the Gathering<a class="anchor" aria-label="anchor" href="#promises-the-gathering"></a>
</h4>
<p>This solution uses the <a href="https://rstudio.github.io/promises/articles/promises_07_combining.html#gathering">promise
gathering</a> pattern, which combines <code>promises_all</code>,
<code>then</code>, and <code>with</code>.</p>
<ul>
<li>The <code>promise_all</code> function gathers multiple promise
objects together, and returns a single promise object. This new promise
object doesn’t resolve until all the input promise objects are resolved,
and it yields a list of those results.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/promise_all.html">promise_all</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></span><span class="op">(</span><span class="st">"Hello"</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></span><span class="op">(</span><span class="st">"World"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span><span class="va">print</span><span class="op">)</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; [1] "Hello"</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] "World"</span></span></code></pre></div>
<ul>
<li>The <code>then</code>, as before, “unwraps” the promise object and
passes the result to its right hand side.</li>
<li>The <code>with</code> function (from base R) takes a named list, and
makes it into a sort of virtual parent environment while evaluating a
code block you pass it.</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">+</span> <span class="va">y</span></span>
<span><span class="co">#&gt; Error: object 'x' not found</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span>, y <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">+</span> <span class="va">y</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>Let’s once again combine the three, with the simplest possible
example of the gathering pattern:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/promise_all.html">promise_all</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></span><span class="op">(</span><span class="st">"Hello"</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></span><span class="op">(</span><span class="st">"World"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">values</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">values</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span><span class="va">print</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Hello World"</span></span></code></pre></div>
<p>You can make use of this pattern without remembering exactly how
these pieces combine. Just remember that the arguments to
<code>promise_all</code> provide the promise objects
(<code>mirai(1)</code> and <code>mirai(2)</code>), along with the names
you want to use to refer to their yielded values (<code>x</code> and
<code>y</code>); and the code block you put in <code><a href="https://rdrr.io/r/base/with.html" class="external-link">with()</a></code> can
refer to those names without worrying about the fact that they were ever
promises to begin with.</p>
</div>
</div>
<div class="section level3">
<h3 id="the-total_downloaders-value-box-simple-pipelines-are-for-output-too">The <code>total_downloaders</code> value box: simple pipelines are
for output, too<a class="anchor" aria-label="anchor" href="#the-total_downloaders-value-box-simple-pipelines-are-for-output-too"></a>
</h3>
<div class="float">
<img src="case-study-downloaders.png" alt="Over 52 thousand unique downloaders"><div class="figcaption">Over 52 thousand unique downloaders</div>
</div>
<p>All of the value boxes in this app ended up looking a lot like
this:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># SYNCHRONOUS version</span></span>
<span></span>
<span><span class="va">output</span><span class="op">$</span><span class="va">total_downloaders</span> <span class="op">&lt;-</span> <span class="fu">renderValueBox</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">pull</span><span class="op">(</span><span class="va">ip_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span>big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">valueBox</span><span class="op">(</span><span class="st">"unique downloaders"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>This is structurally no different than the <code>whales</code>
best-case scenario reactive. One thing worth pointing out is that an
async <code>renderValueBox</code> means you return a promise that
returns a <code>valueBox</code>; you <em>don’t</em> return a
<code>valueBox</code> to whom you have passed a promise.</p>
<p>Meaning, you <em>don’t</em> do this:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># BAD VERSION DOESN'T WORK</span></span>
<span></span>
<span><span class="va">output</span><span class="op">$</span><span class="va">total_downloaders</span> <span class="op">&lt;-</span> <span class="fu">renderValueBox</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">valueBox</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="fu">pull</span><span class="op">(</span><span class="va">df</span>, <span class="va">ip_id</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span><span class="va">length</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">n</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"unique downloaders"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Instead, you do this:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ASYNCHRONOUS version</span></span>
<span></span>
<span><span class="va">output</span><span class="op">$</span><span class="va">total_downloaders</span> <span class="op">&lt;-</span> <span class="fu">renderValueBox</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="fu">pull</span><span class="op">(</span><span class="va">df</span>, <span class="va">ip_id</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span><span class="va">length</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">n</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">val</span><span class="op">)</span> <span class="fu">valueBox</span><span class="op">(</span><span class="va">val</span>, <span class="st">"unique downloaders"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The other trick worth nothing is the <code>pull</code> verb, which is
used to retrieve a specific column of a data frame as a vector (similar
to <code>$</code> or <code>[[</code>). In this case,
<code>pull(data, ip_id)</code> is equivalent to
<code>data[["ip_id"]]</code>. Note that <code>pull</code> is part of
dplyr and isn’t specific to promises.</p>
</div>
<div class="section level3">
<h3 id="the-biggest_whales-plot-getting-untidy">The <code>biggest_whales</code> plot: getting untidy<a class="anchor" aria-label="anchor" href="#the-biggest_whales-plot-getting-untidy"></a>
</h3>
<p>In a cruel twist of API design fate, one of the cornerstone packages
of the tidyverse lacks a tidy API. I’m referring, of course, to
<code>ggplot2</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># SYNCHRONOUS version</span></span>
<span></span>
<span><span class="va">output</span><span class="op">$</span><span class="va">downloaders</span> <span class="op">&lt;-</span> <span class="fu">renderPlot</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">whales</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">ip_name</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_bar</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"Downloads on this day"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>While <code>dplyr</code> and other tidyverse packages are designed to
link calls together with <code>|&gt;</code>, the older
<code>ggplot2</code> package uses the <code>+</code> operator. This is
mostly a small aesthetic wart when synchronous code, but it’s a real
problem with async, because the <code>promises</code> package doesn’t
currently have a promise-aware replacement for <code>+</code> like it
does for <code>|&gt;</code>.</p>
<p>Instead of a pipeline stage being a simple function call, you can
perform a multi-line code block inside a <code><a href="../reference/then.html">then()</a></code>
wrapper.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ASYNCHRONOUS version</span></span>
<span></span>
<span><span class="va">output</span><span class="op">$</span><span class="va">downloaders</span> <span class="op">&lt;-</span> <span class="fu">renderPlot</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">whales</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">whale_df</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">ggplot</span><span class="op">(</span><span class="va">whale_df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">ip_name</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu">geom_bar</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu">ylab</span><span class="op">(</span><span class="st">"Downloads on this day"</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><strong>The importance of this pattern cannot be overstated!</strong>
Using <code><a href="../reference/then.html">then()</a></code> and simple calls alone, you’re restricted to
doing pipeline-compatible operations. But <code><a href="../reference/then.html">then()</a></code> together
with a curly-brace code block means your handler code can be any shape
or size. You can have zero, one, or more statements.</p>
</div>
<div class="section level3">
<h3 id="revisiting-the-data-reactive-progress-support">Revisiting the <code>data</code> reactive: progress support<a class="anchor" aria-label="anchor" href="#revisiting-the-data-reactive-progress-support"></a>
</h3>
<p>Now that we have discussed a few techniques for writing async code,
let’s come back to our original <code>data</code> event reactive, and
this time do a more faithful async conversion that preserves the
progress reporting functionality of the original.</p>
<p>Again, here’s the original sync code:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># SYNCHRONOUS version</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">eventReactive</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span>, <span class="op">{</span></span>
<span>  <span class="va">date</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">date</span>  <span class="co"># Example: 2018-05-28</span></span>
<span>  <span class="va">year</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu">year</span><span class="op">(</span><span class="va">date</span><span class="op">)</span>  <span class="co"># Example: "2018"</span></span>
<span></span>
<span>  <span class="va">url</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"http://cran-logs.rstudio.com/{year}/{date}.csv.gz"</span><span class="op">)</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"data_cache"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">".csv.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">withProgress</span><span class="op">(</span>value <span class="op">=</span> <span class="cn">NULL</span>, <span class="op">{</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">setProgress</span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Downloading data..."</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="va">url</span>, <span class="va">path</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu">setProgress</span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Parsing data..."</span><span class="op">)</span></span>
<span>    <span class="fu">read_csv</span><span class="op">(</span><span class="va">path</span>, col_types <span class="op">=</span> <span class="st">"Dti---c-ci"</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Progress reporting currently presents two challenges for mirai.</p>
<p>First, the <code>withProgress({...})</code> function cannot be used
with async. <code>withProgress</code> is designed to wrap a slow
synchronous action, and dismisses its progress dialog when the block of
code it wraps is done executing. Since the call to <code><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai()</a></code>
will return immediately even though the actual task is far from done,
using <code>withProgress</code> won’t work; the progress dialog would be
dismissed before the download even got going.</p>
<p>It’s conceivable that <code>withProgress</code> could gain promise
compatibility someday, but it’s not in Shiny v1.1.0. In the meantime, we
can work around this by using the alternative, <a href="https://shiny.posit.co/r/reference/shiny/latest/progress.html" class="external-link">object-oriented
progress API</a> that Shiny offers. It’s a bit more verbose and fiddly
than <code>withProgress</code>/<code>setProgress</code>, but it is
flexible enough to work with mirai/promises.</p>
<p>Second, progress messages can’t be sent from mirai. This is simply
because mirai are executed in child processes, which don’t have direct
access to the browser like the main Shiny process does.</p>
<p>It’s conceivable that <code>mirai</code> could gain the ability for
child processes to communicate back to their parents, but no good
solution exists at the time of this writing. In the meantime, we can
work around this by taking the one mirai that does both downloading and
parsing, and splitting it into two separate mirai. After the download
mirai has completed, we can send a progress message that parsing is
beginning, and then start the parsing mirai.</p>
<p>The regrettably complicated solution is below.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ASYNCHRONOUS version</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">eventReactive</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span>, <span class="op">{</span></span>
<span>  <span class="va">date</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">date</span></span>
<span>  <span class="va">year</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu">year</span><span class="op">(</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">url</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"http://cran-logs.rstudio.com/{year}/{date}.csv.gz"</span><span class="op">)</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"data_cache"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">".csv.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">Progress</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">p</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>value <span class="op">=</span> <span class="cn">NULL</span>, message <span class="op">=</span> <span class="st">"Downloading data..."</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="va">url</span>, <span class="va">path</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span>,</span>
<span>    path <span class="op">=</span> <span class="va">path</span>,</span>
<span>    url <span class="op">=</span> <span class="va">url</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="op">)</span> <span class="va">p</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Parsing data..."</span><span class="op">)</span> <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></span><span class="op">(</span></span>
<span>        <span class="op">{</span></span>
<span>          <span class="fu">read_csv</span><span class="op">(</span><span class="va">path</span>, col_types <span class="op">=</span> <span class="st">"Dti---c-ci"</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>        <span class="op">}</span>,</span>
<span>        path <span class="op">=</span> <span class="va">path</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">finally</a></span><span class="op">(</span>\<span class="op">(</span><span class="op">)</span> <span class="va">p</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The single mirai we wrote earlier has now become a pipeline of
promises:</p>
<ol style="list-style-type: decimal">
<li>mirai (download)</li>
<li>send progress message</li>
<li>mirai (parse)</li>
<li>dismiss progress dialog</li>
</ol>
<p>Note that neither the R6 call <code>p$set(message = ...)</code> nor
the second <code><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai()</a></code> call are tidy, so they use curly-brace
blocks, as discussed in the above section about
<code>biggest_whales</code>.</p>
<p>The final step of dismissing the progress dialog doesn’t use
<code><a href="../reference/then.html">then()</a></code> at all; because we want the progress dialog to
dismiss whether the download and parse operations succeed or fail, we
use <code><a href="../reference/then.html">finally()</a></code> operator instead. See the relevant section in
<a href="https://rstudio.github.io/promises/articles/promises_03_overview.html#cleaning-up-with-finally"><em>Working
with promises in R</em></a> to learn more.</p>
<p>With these changes in place, we’ve now covered all of the changes to
the application. You can see the full changes side-by-side via <a href="https://github.com/rstudio/cranwhales/compare/sync...async?diff=split" class="external-link">this
GitHub diff</a>.</p>
</div>
</div>
<div class="section level2">
<h2 id="measuring-scalability">Measuring scalability<a class="anchor" aria-label="anchor" href="#measuring-scalability"></a>
</h2>
<p>It was a fair amount of work to do the sync-to-async conversion. Now
we’d like to know if the conversion to async had the desired effect:
improved responsiveness (i.e. lower latency) when the number of
simultaneous visitors increases.</p>
<div class="section level3">
<h3 id="load-testing-with-shiny-coming-soon">Load testing with Shiny (coming soon)<a class="anchor" aria-label="anchor" href="#load-testing-with-shiny-coming-soon"></a>
</h3>
<p>At the time of this writing, we are working on a suite of load
testing tools for Shiny that is not publicly available yet, but was
previewed by Sean Lopp during his <a href="https://posit.co/resources/" class="external-link">epic rstudio::conf 2018 talk</a>
about running a Shiny load test with 10,000 simulated concurrent
users.</p>
<p>You use these tools to easily <strong>record</strong> yourself using
your Shiny app, which creates a test script; then <strong>play
back</strong> that test script, but multiplied by
dozens/hundreds/thousands of simulated concurrent users; and finally,
<strong>analyze</strong> the timing data generated during the playback
step to see what kind of latency the simulated users experienced.</p>
<p>To examine the effects of my async refactor, I recorded a simple test
script by loading up the app, waiting for the first tab to appear, then
clicking through each of the other tabs, pausing for several seconds
each time before moving on to the next. When using the app without any
other visitors, the homepage fully loads in less than a second, and the
initial loading of data and rendering of the plot on the default tab
takes about 7 seconds. After that, each tab takes no more than a couple
of seconds to load. Overall, the entire test script, including time
where the user is thinking, takes about 40 seconds under ideal settings
(i.e. only a single concurrent user).</p>
<p>I then used this test script to generate load against the Shiny app
running in my local RStudio. With the settings I chose, the playback
tool introduced one new “user” session every 5 seconds, until 50
sessions total had been launched; then it waited until all the sessions
were complete. I ran this test on both the sync and async versions in
turn, which generated the following results.</p>
</div>
<div class="section level3">
<h3 id="sync-vs--async-performance">Sync vs. async performance<a class="anchor" aria-label="anchor" href="#sync-vs--async-performance"></a>
</h3>
<div class="float">
<img src="case-study-gantt-async.png" alt="Slower response time of sync served home pages"><div class="figcaption">Slower response time of sync served home
pages</div>
</div>
<p>In this plot, each row represents a single session, and the x
dimension represents time. Each of the rectangles represents a single
“step” in the test script, be it downloading the HTML for the homepage,
fetching one of the two dozen JavaScript/CSS files, or waiting for the
server to update outputs. So the wider a rectangle is, the longer the
user had to wait. (The empty gaps between rectangles represents time the
app is waiting for the user to click an input; their widths are
hard-coded into the test script.)</p>
<p>Of particular importance are the red and pink rectangles, as these
represent the initial page load. While these are taking place, the user
is staring at a blank page, probably wondering if the server is down.
Long waits during this stage are not only undesirable, but surprising
and incomprehensible to the user; whereas the same user is probably
prepared to wait a little while for a complicated visualization to be
rendered in response to an input change.</p>
<p>And as you can see from this plot, the behavior of the async app is
much improved in the critical metric of homepage/JS/CSS loading time.
The sync version of the app starts displaying unacceptably long red/pink
loading times as early as session 15, and by session #44 the maximum
page load time has exceeded one minute. The async version at that point
is showing 25 second load times, which is far from great, but still a
significant step in the right direction.</p>
</div>
<div class="section level3">
<h3 id="further-optimizations">Further optimizations<a class="anchor" aria-label="anchor" href="#further-optimizations"></a>
</h3>
<p>I was surprised that the async version’s page load times weren’t even
faster, and even more surprised to see that the blue rectangles were
just as wide as the sync version. Why isn’t the async version way
faster? The sync version does all of its work on a single thread, and I
specifically designed this app to be a nightmare for scalability by
having each session kick off by parsing hundreds of megabytes of CSV, an
operation that is quite expensive. The async version gets to spread
these jobs across several workers. Why aren’t we seeing a greater time
savings?</p>
<p>Mostly, it’s because calling
<code>mirai(read_csv("big_file.csv"))</code> is almost a worst-case
scenario for mirai and async. <code>read_csv</code> is generally fast,
but because the CRAN log files are so big,
<code>read_csv("big_file.csv")</code> is slow. The value it returns is a
very large data frame, that has now been loaded not into the Shiny
process, but a <code>mirai</code> daemon process. In order to return
that data frame to the Shiny process, that data must first be
serialized, transmitted to the Shiny process, and then deserialized; to
make matters worse, the transmitting and deserialization steps happen on
the main R thread that we’re working so hard to try to keep idle.
<strong>The larger the data we send back and forth to the mirai, the
more performance suffers,</strong> and in this case we’re sending back
quite a lot of data.</p>
<p>We can make our code significantly faster by doing more summarizing,
aggregation, and filtering <em>inside</em> the mirai; not only does this
make more of the work happen in parallel, but by returning the data in
already-processed form, we can have much less data to transfer from the
worker process back to the Shiny process. (For example, the data for May
31, 2018 weighs 75MB before optimization, and 8.8MB afterwards.)</p>
<p>Compare all three runs in the image below (the newly optimized
version is labelled “async2”). The homepage load times have dropped
further, and the calculation times are now dramatically faster than the
sync code.</p>
<div class="float">
<img src="case-study-gantt-async2.png" alt="Faster response times using async served static assets"><div class="figcaption">Faster response times using async served static
assets</div>
</div>
<p>Looking at the “async2” graph, the leading (bottom-left) edge has the
same shape as before, as that’s simply the rate at which the load
testing tool launches new sessions. But notice how much more closely the
trailing (upper-right) edge matches the leading edge! It means that even
as the number of active sessions ramped up, the amount of latency didn’t
get dramatically worse, unlike with the “sync” and “async” versions. And
each of the individual blue rectangles in the “async2” are comparatively
tiny, meaning that users never have to wait more than a dozen seconds at
the most for plots to update.</p>
<p>This last plot shows the same data as above, but with the sessions
aligned by start time. You can clearly see how the sessions are both
shorter and less variable in “async2” compared to the others. I’ve added
a yellow vertical line at the 10 second mark; if the page load
(red/pink) has not completed at this point, it’s likely that your
visitor has left in disgust. While “async” does better than “sync”, they
both break through the 10 second mark early and often. In contrast, the
“async2” version just barely peeks over the line three times.</p>
<div class="float">
<img src="case-study-gantt-aligned.png" alt="Session timing aligned by start time displaying async2 is much better."><div class="figcaption">Session timing aligned by start time displaying
async2 is much better.</div>
</div>
<p>To get a visceral sense for what it feels like to use the app under
load, here’s a video that shows what it’s like to browse the app while
the load test is running at its peak. The left side of the screen shows
“sync”, the right shows “async2”. In both cases, I navigated to the app
when session #40 was started.</p>
<p class="embed-responsive embed-responsive-16by9">
<iframe class="embed-responsive-item" src="https://www.youtube-nocookie.com/embed/HsjdEZMnb0w?rel=0&amp;showinfo=0&amp;ecver=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
</iframe>
</p>
<p>Take a look at the <a href="https://github.com/rstudio/cranwhales/compare/async...async2?diff=split" class="external-link">code
diff for async vs. async2</a>. While the code has not changed very
dramatically, it has lost a little elegance and maintainability: the
code for each of the affected outputs now has one foot in the the render
function and one foot in the mirai. If your app’s total audience is a
team of a hundred analysts and execs, you may choose to forgo the extra
performance and stick with the original async (or even sync) code. But
if you have serious scaling needs, the refactoring is probably a small
price to pay.</p>
<p>Let’s get real for a second, though. If this weren’t an example app
written for exposition purposes, but a real production app that was
intended to scale to thousands of concurrent users across dozens of R
processes, we wouldn’t download and parse CSV files on the fly. Instead,
we’d establish a proper <a href="https://solutions.posit.co/gallery/twitter-etl/" class="external-link">ETL procedure</a>
to run every night and put the results into a properly indexed database
table, or RDS files with just the data we need. As I said <a href="#improving-performance-and-scalability">earlier</a>, a little
precomputation and caching can make a huge difference!</p>
<p>Much of the remaining latency for the async2 branch is from ggplot2
plotting. <a href="https://posit.co/resources/" class="external-link">Sean’s talk</a> alluded
to some upcoming plot caching features we’re adding to Shiny, and I
imagine they will have as dramatic an effect for this test as they did
for Sean.</p>
</div>
</div>
<div class="section level2">
<h2 id="summing-up">Summing up<a class="anchor" aria-label="anchor" href="#summing-up"></a>
</h2>
<p>With async programming, expensive computations and tasks no longer
need to be the scalability killers that they once were for Shiny. Armed
with this and other common techniques like precomputation, caching, and
load balancing, it’s possible to write responsive and scalable Shiny
applications that can be safely deployed to thousands of concurrent
users.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Joe Cheng, Barret Schloerke, Winston Chang, Charlie Gao, Posit Software, PBC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
