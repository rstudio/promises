<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title> OpenTelemetry integration — with_ospan_async • promises</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Nunito-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content=" OpenTelemetry integration — with_ospan_async"><meta name="description" content="otel provides tools for integrating with OpenTelemetry, a framework for
observability and tracing in distributed systems.
These methods are intended to enhance the framework to be used with the
promises package, not as a generic replacement.
Developer note - Barret 2025/09: This ospan handoff promise domain topic is
complex and has been discussed over many hours. Many advanced Shiny/R
developers are not even aware of promise domains (very reasonable!),
therefore this topic requires more in-depth documentation and examples."><meta property="og:description" content="otel provides tools for integrating with OpenTelemetry, a framework for
observability and tracing in distributed systems.
These methods are intended to enhance the framework to be used with the
promises package, not as a generic replacement.
Developer note - Barret 2025/09: This ospan handoff promise domain topic is
complex and has been discussed over many hours. Many advanced Shiny/R
developers are not even aware of promise domains (very reasonable!),
therefore this topic requires more in-depth documentation and examples."><meta property="og:image" content="https://rstudio.github.io/promises/logo.svg"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">promises</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><h6 class="dropdown-header" data-toc-skip>Overview</h6></li>
    <li><a class="dropdown-item" href="../articles/promises_01_motivation.html">1. Why use promises?</a></li>
    <li><a class="dropdown-item" href="../articles/promises_02_intro.html">2. An informal intro to async programming</a></li>
    <li><a class="dropdown-item" href="../articles/promises_03_overview.html">3. Working with promises</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Integration</h6></li>
    <li><a class="dropdown-item" href="../articles/promises_04_mirai.html">4. Launching tasks with mirai</a></li>
    <li><a class="dropdown-item" href="../articles/promises_05a_futures.html">5a. Launching tasks with future</a></li>
    <li><a class="dropdown-item" href="../articles/promises_05b_future_promise.html">5b. Advanced future and promises usage</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Usage</h6></li>
    <li><a class="dropdown-item" href="../articles/promises_06_shiny.html">6. Using promises with Shiny</a></li>
    <li><a class="dropdown-item" href="../articles/promises_07_combining.html">7. Combining promises</a></li>
    <li><a class="dropdown-item" href="../articles/promises_08_casestudy.html">8. Case study: Converting a Shiny app to async</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rstudio/promises/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="figures/lifecycle-experimental.svg" alt="[Experimental]"></a> OpenTelemetry integration</h1>
      <small class="dont-index">Source: <a href="https://github.com/rstudio/promises/blob/rc-v1.5.0/R/otel.R" class="external-link"><code>R/otel.R</code></a></small>
      <div class="d-none name"><code>otel.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><span class="pkg">otel</span> provides tools for integrating with OpenTelemetry, a framework for
observability and tracing in distributed systems.</p>
<p>These methods are intended to enhance the framework to be used with the
<span class="pkg">promises</span> package, not as a generic replacement.</p>
<p>Developer note - Barret 2025/09: This ospan handoff promise domain topic is
complex and has been discussed over many hours. Many advanced Shiny/R
developers are not even aware of promise domains (very reasonable!),
therefore this topic requires more in-depth documentation and examples.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">with_ospan_async</span><span class="op">(</span><span class="va">name</span>, <span class="va">expr</span>, <span class="va">...</span>, <span class="va">tracer</span>, attributes <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">with_ospan_promise_domain</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">local_ospan_promise_domain</span><span class="op">(</span>envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-name">name<a class="anchor" aria-label="anchor" href="#arg-name"></a></dt>
<dd><p>Character string. The name of the ospan.</p></dd>


<dt id="arg-expr">expr<a class="anchor" aria-label="anchor" href="#arg-expr"></a></dt>
<dd><p>An expression to evaluate within the ospan context.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments passed to <code><a href="https://otel.r-lib.org/reference/start_span.html" class="external-link">otel::start_span()</a></code>.</p></dd>


<dt id="arg-tracer">tracer<a class="anchor" aria-label="anchor" href="#arg-tracer"></a></dt>
<dd><p>(Required) An <code>{otel}</code> tracer. It is required to provide your
own tracer from your own package. See <code><a href="https://otel.r-lib.org/reference/get_tracer.html" class="external-link">otel::get_tracer()</a></code> for more
details.</p></dd>


<dt id="arg-attributes">attributes<a class="anchor" aria-label="anchor" href="#arg-attributes"></a></dt>
<dd><p>Attributes passed through <code><a href="https://otel.r-lib.org/reference/as_attributes.html" class="external-link">otel::as_attributes()</a></code> (when
not <code>NULL</code>)</p></dd>


<dt id="arg-envir">envir<a class="anchor" aria-label="anchor" href="#arg-envir"></a></dt>
<dd><p>The "local" environment in which to add the promise domain. When
the environment is exited, the promise domain is removed.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="functions">Functions<a class="anchor" aria-label="anchor" href="#functions"></a></h2>

<ul><li><p><code>with_ospan_async()</code>: <a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="figures/lifecycle-experimental.svg" alt="[Experimental]"></a></p>
<p>Creates an OpenTelemetry span, executes the given expression within it, and
ends the span.</p>
<p>This method <strong>requires</strong> the use of <code>with_ospan_promise_domain()</code>
to be within the execution stack.</p>
<p>This function is designed to handle both synchronous and asynchronous
(promise-based) operations. For promises, the span is automatically ended
when the promise resolves or rejects.</p>
<p>Returns the result of evaluating <code>expr</code>. If <code>expr</code> returns a promise, the
span will be automatically ended when the promise completes.</p>
<p>This function differs from synchronous otel span operations in that it
installs a promise domain and properly handles asynchronous operations. In
addition, the internal span will be ended either when the function exits (for
synchronous operations) or when a returned promise completes (for
asynchronous operations).</p>
<p>If OpenTelemetry is not enabled, the expression will be evaluated without any
tracing context.</p></li>
<li><p><code>with_ospan_promise_domain()</code>: <a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="figures/lifecycle-experimental.svg" alt="[Experimental]"></a></p>
<p>Adds an idempotent handoff Active OpenTelemetry span promise domain.</p>
<p>Package authors are required to use this function to have otel span context
persist across asynchronous boundaries. This method is only needed once per
promise domain stack. If you are unsure, feel free to call
<code>with_ospan_promise_domain()</code> as the underlying promise domain will only be
added if not found within the current promise domain stack. If your package
<strong>only</strong> works within Shiny apps, Shiny will have already added the domain so
no need to add it yourself. If your package works outside of Shiny and you
use <code>{promises}</code> (i.e. <code>{chromote}</code>), then you'll need to use this wrapper
method.</p>
<p>This method adds a <em>handoff</em> Active OpenTelemetry span promise domain to the
expression evaluation. This <em>handoff</em> promise domain will only run once on
reactivation. This is critical if there are many layered <code>with_ospan_async()</code>
calls, such as within Shiny reactivity. For example, if we nested many
<code>with_ospan_async()</code> of which each added a promise domain that reactivated
each ospan on restore, we'd reactivate <code>k</code> ospan objects (<code>O(k)</code>) when we
only need to activate the <strong>last</strong> span (<code>O(1)</code>).</p>
<p>Returns the result of evaluating <code>expr</code> within the ospan promise domain.</p></li>
<li><p><code>local_ospan_promise_domain()</code>: <a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="figures/lifecycle-experimental.svg" alt="[Experimental]"></a></p>
<p>Local OpenTelemetry span promise domain</p>
<p>Adds an OpenTelemetry span promise domain to the local scope. This is useful
for <code>{coro}</code> operations where encapsulating the coro operations inside a
<code>with_*()</code> methods is not allowed.</p>
<p>When not using <code>{coro}</code>, please prefer to use <code>with_ospan_async()</code> or
<code>with_ospan_promise_domain()</code>.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="definitions">Definitions<a class="anchor" aria-label="anchor" href="#definitions"></a></h2>


<ul><li><p>Promise domain: An environment in which has setup/teardown methods. These
environments can be composed together to facilitate execution context for
promises. In normal R execution, this can be achieved with scope / stack.
But for complex situations, such as the currently open graphics device,
async operations require promise domains to setup/teardown these contexts
to function properly. Otherwise a multi-stage promise that adds to the
graphics device at each stage will only ever print to the most recently
created graphics device, not the associated graphics device. These promise
domains are not automatically created, they must be manually added to the
execution stack, for example <code>with_ospan_promise_domain()</code> does this for
OpenTelemetry spans ("ospan").</p></li>
<li><p>Promise domain restoration: When switching from one promise chain to
another, the execution context is torn down and then re-established. This
re-establishment is called "promise domain restoration". During this
process, the promise domains are restored in their previously established
combination order.</p></li>
<li><p>Promise chain: A set of promise objects to execute over multiple async
ticks.</p></li>
<li><p>Async tick: the number of times an event loop must run to move computation
forward. (Similar to a JavaScript event loop tick.)</p></li>
<li><p><code><a href="then.html">then()</a></code> promise domain capture: When <code><a href="then.html">then()</a></code> is called, it will capture
the current promise domain. This promise domain is restored (only if
needed) when evaluating the given <code>onFulfilled</code> and <code>onRejected</code> callbacks.
This captured promise domain does not go into any downstream promise chain
objects. The only way the promise domain is captured is exactly when the
<code><a href="then.html">then()</a></code> method is called.</p></li>
</ul><p><code>with_ospan_promise_domain()</code> creates a promise domain that restores the
currently active OpenTelemetry span from when a call to <code><a href="then.html">promises::then()</a></code> is
executed. Given the special circumstance where only the current ospan is
needed to continue recording (not a full ancestry tree of ospans), we can
capture <em>just</em> the current ospan and reactivate that ospan during promise
domain restoration.</p>
    </div>
    <div class="section level2">
    <h2 id="when-promise-domains-are-captured">When promise domains are captured<a class="anchor" aria-label="anchor" href="#when-promise-domains-are-captured"></a></h2>



<p>Asynchronous operation</p><ul><li><p>Creates <code>async_op</code> ospan</p></li>
<li><p>Automatically ends the ospan (<code>async_op</code>) when the promise (p)
resolves or rejects</p></li>
</ul><p>The code below illustrates an example of when the promise domain are
created/captured/restored and when ospan objects are
created/activated/reactivated/ended.</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="co"># t0.0</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otel.html">with_ospan_promise_domain</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># t0.1</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otel.html">with_ospan_async</a></span><span class="op">(</span><span class="st">"async_op"</span>, <span class="op">{</span></span>
<span>    <span class="co"># ... return a promise ...</span></span>
<span>    <span class="fu">init_async_work</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># t0.2</span></span>
<span>      <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span> <span class="co"># t0.3</span></span>
<span>        <span class="va">some_async_work</span> <span class="co"># t1.0</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="co"># t0.4, t1.0, t2.0</span></span>
<span>  <span class="va">p</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span> <span class="co"># t0.5</span></span>
<span>      <span class="va">more_async_work</span> <span class="co"># t3.0</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co"># t0.6</span></span>
<span></span>
<span><span class="va">p_final</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">p2</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/then.html">then</a></span><span class="op">(</span> <span class="co"># t0.7</span></span>
<span>    <span class="va">final_work</span> <span class="co"># t4.0</span></span>
<span>  <span class="op">)</span></span></code></pre><p></p></div>
<p>An in-depth explanation of the execution timeline is below.</p><ul><li><p>At the first initial tick, <code>t0.*</code>:</p><ul><li><p><code>t0.0</code>: The code is wrapped in <code>with_ospan_promise_domain()</code></p></li>
<li><p><code>t0.1</code>: The <code>async_op</code> ospan is created and activated</p></li>
<li><p><code>t0.2</code>: Some async work is initiated</p></li>
<li><p><code>t0.3</code>: <code><a href="then.html">then()</a></code> is called, capturing the active <code>async_op</code> ospan (as it
is called within <code>with_ospan_promise_domain()</code>)</p></li>
<li><p><code>t0.4</code>: The <code>with_ospan_async()</code> call exits, but the <code>async_op</code> ospan is
not ended as the promise is still pending. The returned promise has a
<code><a href="then.html">finally()</a></code> step added to it that will end the ospan <code>async_op</code> when <code>p</code>
is resolved.</p></li>
<li><p><code>t0.5</code>: Another <code><a href="then.html">then()</a></code> is called, but there is no active ospan to
capture</p></li>
<li><p><code>t0.6</code>: The ospan promise domain call exits</p></li>
<li><p><code>t0.7</code>: Another <code><a href="then.html">then()</a></code> is called. No ospan will be captured as there is
no active ospan / promise domain</p></li>
</ul></li>
<li><p>At the first followup tick, <code>t1.0</code>:</p><ul><li><p>The active <code>async_op</code> ospan is reactivated during promise domain
restoration for the duration of the <code>then</code> callback</p></li>
<li><p>The <code>some_async_work</code> function is called</p></li>
</ul></li>
<li><p>At tick, <code>t2.0</code>:</p><ul><li><p><code>some_async_work</code> has resolved</p></li>
<li><p>A hidden <code><a href="then.html">finally()</a></code> step closes the ospan, <code>async_op</code></p></li>
<li><p><code>p</code> is now resolved</p></li>
</ul></li>
<li><p>At tick, <code>t3.0</code>:</p><ul><li><p>There is no active ospan at <code>t0.5</code>, so no ospan is reactivated during
promise domain restoration</p></li>
<li><p>The <code>more_async_work</code> function is executed</p></li>
</ul></li>
<li><p>At tick, <code>t4.0</code>:</p><ul><li><p><code>more_async_work</code> has resolved, therefore <code>p2</code> is now resolved</p></li>
<li><p>There was no ospan promise domain at <code>t0.7</code>, so no attempt is made to
reactivate any ospan</p></li>
<li><p>The <code>final_work</code> function is executed</p></li>
</ul></li>
<li><p>At tick, <code>t5.0</code>:</p><ul><li><p><code>p_final</code> has resolved</p></li>
</ul></li>
</ul></div>
    <div class="section level2">
    <h2 id="complexity">Complexity<a class="anchor" aria-label="anchor" href="#complexity"></a></h2>



<p>When reactivating the <code>k</code>th step in a promise chain, the currently active
ospan (during the call to <code><a href="then.html">then()</a></code>) will be reactivated during promise domain
restoration (<code>O(1)</code>). To restore a chain of promises, the active ospan will
be restored at each step (<code>O(n)</code>) due to the <strong><code>n</code></strong> calls to wrapping each
<code>onFulfilled</code> and <code>onRejected</code> callbacks inside <code><a href="then.html">then()</a></code>.</p>
<p>If we did NOT have a handoff promise domain for ospan restoration, a regular
promise domain approach would be needed at each step to restore the active
ospan. Each step would call <code>with_active_span()</code> <code>k</code> times (<code>O(k)</code>, where as
handoff domain computes in <code>O(1)</code>). Taking a step back, to restore each ospan
at for every step in a promise chain would then take <code>O(n^2)</code> time, not
<code>O(n)</code>. The standard, naive promise domain approach does not scale for
multiple similar promise domain restorations.</p>
    </div>
    <div class="section level2">
    <h2 id="execution-model-for-with-ospan-promise-domain-">Execution model for <code>with_ospan_promise_domain()</code><a class="anchor" aria-label="anchor" href="#execution-model-for-with-ospan-promise-domain-"></a></h2>


<ol><li><p><code>with_ospan_promise_domain(expr)</code> is called.</p><ul><li><p>The following steps all occur within <code>expr</code>.</p></li>
</ul></li>
<li><p>Create an ospan object using <code><a href="https://otel.r-lib.org/reference/start_span.html" class="external-link">otel::start_span()</a></code>.</p><ul><li><p>We need the ospan to be active during the a followup async operation.
Therefore, <code><a href="https://otel.r-lib.org/reference/start_local_active_span.html" class="external-link">otel::start_local_active_span()</a></code> is not appropriate as the
ospan would be ended when the function exits, not when the promise chain
resolves.</p></li>
</ul></li>
<li><p>Be sure your ospan is activated before calling <code><a href="then.html">promises::then()</a></code>.</p><ul><li><p>Activate it using <code>with_ospan_async(name, expr)</code> (which also
creates/ends the ospan) or <code>otel::with_active_span(span, expr)</code>.</p></li>
</ul></li>
<li><p>Call <code><a href="then.html">promises::then()</a></code></p></li>
</ol><ul><li><p>When <code><a href="then.html">promises::then()</a></code> is called, the two methods (<code>onFulfilled</code> and
<code>onRejected</code>) capture the currently active spans. (Performed by the
initial <code>with_ospan_promise_domain()</code>)</p></li>
</ul><ol><li><p>During reactivation of the promise chain step, the previously captured
ospan is reactivated via <code>with_active_span()</code>. (Performed by the initial
<code>with_ospan_promise_domain()</code>)</p></li>
</ol></div>
    <div class="section level2">
    <h2 id="opentelemetry-span-compatibility">OpenTelemetry span compatibility<a class="anchor" aria-label="anchor" href="#opentelemetry-span-compatibility"></a></h2>



<p>For ospan objects to exist over may async ticks, the ospan must be created
using <code><a href="https://otel.r-lib.org/reference/start_span.html" class="external-link">otel::start_span()</a></code> and later ended using <code><a href="https://otel.r-lib.org/reference/end_span.html" class="external-link">otel::end_span()</a></code>. Ending
the ospan must occur <strong>after</strong> any promise chain work has completed.</p>
<p>If we were to instead use <code><a href="https://otel.r-lib.org/reference/start_local_active_span.html" class="external-link">otel::start_local_active_span()</a></code>, the ospan would
be ended when the function exits, not when the promise chain completes. Even
though the local ospan is created, activated, and eventually ended, the ospan
will not exist during reactivation of the ospan promise domain.</p>
<p><code>with_ospan_async()</code> is a convenience method that creates, activates, and
ends the ospan only after the returned promise (if any) resolves. It also
properly handles both synchronous (ending the ospan within <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>) and
asynchronous operations (ending the ospan within <code><a href="then.html">promises::finally()</a></code>).</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="https://otel.r-lib.org/reference/start_span.html" class="external-link">otel::start_span()</a></code>, <code><a href="https://otel.r-lib.org/reference/with_active_span.html" class="external-link">otel::with_active_span()</a></code>,
<code><a href="https://otel.r-lib.org/reference/end_span.html" class="external-link">otel::end_span()</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Common usage:</span></span></span>
<span class="r-in"><span><span class="fu">with_ospan_promise_domain</span><span class="op">(</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="co"># ... deep inside some code execution ...</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Many calls to `with_ospan_async()` within `with_ospan_promise_domain()`</span></span></span>
<span class="r-in"><span>  <span class="fu">with_ospan_async</span><span class="op">(</span><span class="st">"my_operation"</span>, <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="co"># ... do some work ...</span></span></span>
<span class="r-in"><span>  <span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="fu">with_ospan_promise_domain</span><span class="op">(</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="co"># ... deep inside some code execution ...</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Synchronous operation</span></span></span>
<span class="r-in"><span>  <span class="co"># * Creates `my_operation` span</span></span></span>
<span class="r-in"><span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">with_ospan_async</span><span class="op">(</span><span class="st">"my_operation"</span>, <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="co"># ... do some work ...</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="https://otel.r-lib.org/reference/get_active_span.html" class="external-link">get_active_span</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">name</span><span class="op">)</span> <span class="co"># "my_operation"</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>    <span class="co"># Nest (many) more spans</span></span></span>
<span class="r-in"><span>    <span class="va">prom_nested</span> <span class="op">&lt;-</span> <span class="fu">with_ospan_async</span><span class="op">(</span><span class="st">"my_nested_operation"</span>, <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="co"># ... do some more work ...</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="promise_resolve.html">promise_resolve</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>        <span class="fu"><a href="then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>          <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="https://otel.r-lib.org/reference/get_active_span.html" class="external-link">get_active_span</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">name</span><span class="op">)</span> <span class="co"># "my_nested_operation"</span></span></span>
<span class="r-in"><span>          <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="co"># 42</span></span></span>
<span class="r-in"><span>        <span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>    <span class="co"># Since `then()` is called during the active `my_operation` span,</span></span></span>
<span class="r-in"><span>    <span class="co"># the `my_operation` span will be reactivated in the `then()` callback.</span></span></span>
<span class="r-in"><span>    <span class="va">prom_nested</span> <span class="op">|&gt;</span> <span class="fu"><a href="then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="https://otel.r-lib.org/reference/get_active_span.html" class="external-link">get_active_span</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">name</span><span class="op">)</span> <span class="co"># "my_operation"</span></span></span>
<span class="r-in"><span>      <span class="va">value</span></span></span>
<span class="r-in"><span>    <span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Since `then()` is called where there is no active span,</span></span></span>
<span class="r-in"><span>  <span class="co"># there is no _active_ span in the `then()` callback.</span></span></span>
<span class="r-in"><span>  <span class="va">result</span> <span class="op">|&gt;</span> <span class="fu"><a href="then.html">then</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="https://otel.r-lib.org/reference/get_active_span.html" class="external-link">get_active_span</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"otel_span_noop"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="co"># 42</span></span></span>
<span class="r-in"><span>  <span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Joe Cheng, Barret Schloerke, Winston Chang, Charlie Gao, Posit Software, PBC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

