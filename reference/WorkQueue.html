<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Future promise work queue — WorkQueue • promises</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous"><link href="../docsearch.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Future promise work queue — WorkQueue"><meta property="og:description" content="Future promise work queue
Future promise work queue"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">promises</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.3.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Learning

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/promises_01_motivation.html">1. Why use promises?</a>
    </li>
    <li>
      <a href="../articles/promises_02_intro.html">2. An informal intro to async programming</a>
    </li>
    <li>
      <a href="../articles/promises_03_overview.html">3. Working with promises</a>
    </li>
    <li>
      <a href="../articles/promises_04_futures.html">4. Launching tasks with future</a>
    </li>
    <li>
      <a href="../articles/promises_05_future_promise.html">5. Advanced future and promises usage</a>
    </li>
    <li>
      <a href="../articles/promises_06_shiny.html">6. Using promises with Shiny</a>
    </li>
    <li>
      <a href="../articles/promises_07_combining.html">7. Combining promises</a>
    </li>
    <li>
      <a href="../articles/promises_08_casestudy.html">8. Case study: Converting a Shiny app to async</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/rstudio/promises/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul><form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off"></div>
      </form>

    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Future promise work queue</h1>
    <small class="dont-index">Source: <a href="https://github.com/rstudio/promises/blob/main/R/future_promise.R" class="external-link"><code>R/future_promise.R</code></a></small>
    <div class="hidden name"><code>WorkQueue.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Future promise work queue</p>
<p>Future promise work queue</p>
    </div>


    <div id="details">
    <h2>Details</h2>
    <p>#' <a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="figures/lifecycle-experimental.svg" alt="[Experimental]"></a></p>
<p>An <span class="pkg">R6</span> class to help with scheduling work to be completed. <code>WorkQueue</code> will only execute work if the <code>can_proceed()</code> returns <code>TRUE</code>. For the use case of <code>future</code>, <code>can_proceed()</code> defaults to <code>future::nbrOfFreeWorkers() &gt; 0</code> which will not allow for work to be executed if a <span class="pkg">future</span> worker is not available.</p>
<p><code>WorkQueue</code> will constantly try to start new work once prior work item finishes.  However, if <code>can_proceed()</code> returns <code>FALSE</code> (no future workers are available) and there is more work to be done, then work is attempted later a random amount of time later using exponential backoff.  The exponential backoff will cap out at 10 seconds to prevent unnecessarily large wait times.</p>
<p>Each time <code>WorkQueue</code> tries to start more work, it will repeat until <code>can_proceed()</code> returns <code>FALSE</code> or there is no more work in the <code>queue</code>.</p>
    </div>
    <div id="global-event-loop">
    <h2>Global event loop</h2>



<p>The global loop is used by default as the internal <code>WorkQueue</code> "delayed check" uses a single delay check for the whole queue, rather than having each item in the queue attempt to process.
This behavior might change in the future, but we are not exactly sure how at this point.</p>
<p>If a private <code>later</code> loop wants to become synchronous by running until all jobs are completed but is waiting on a <code><a href="future_promise.html">future_promise()</a></code>, the private loop will not complete unless the global loop is allowed to move forward.</p>
<p>However, it is possible to use a private loop inside a user-defined <code>WorkQueue</code> may work which can be provided directly to <code>future_promise(queue=custom_queue)</code>. Having a concrete example (or need) will help us understand the problem better. If you have an example, please reach out .</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="future_promise.html">future_promise_queue()</a></code> which returns a <code>WorkQueue</code> which is cached per R session.</p></div>
    </div>
    <div id="methods">
    <h2>Methods</h2>

<div class="section">
<h3 id="public-methods">Public methods<a class="anchor" aria-label="anchor" href="#public-methods"></a></h3>

<ul><li><p><a href="#method-WorkQueue-new"><code>WorkQueue$new()</code></a></p></li>
<li><p><a href="#method-WorkQueue-schedule_work"><code>WorkQueue$schedule_work()</code></a></p></li>
<li><p><a href="#method-WorkQueue-clone"><code>WorkQueue$clone()</code></a></p></li>
</ul></div><p></p><hr><a id="method-WorkQueue-new"></a><div class="section">
<h3 id="method-new-">Method <code>new()</code><a class="anchor" aria-label="anchor" href="#method-new-"></a></h3>
<p>Create a new <code>WorkQueue</code></p><div class="section">
<h4 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va"><a href="../reference/WorkQueue.html">WorkQueue</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  can_proceed <span class="op">=</span> <span class="va">future_worker_is_free</span>,</span>
<span>  queue <span class="op">=</span> <span class="fu">fastmap</span><span class="fu">::</span><span class="fu"><a href="https://r-lib.github.io/fastmap/reference/fastqueue.html" class="external-link">fastqueue</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  loop <span class="op">=</span> <span class="fu">later</span><span class="fu">::</span><span class="fu"><a href="https://r-lib.github.io/later/reference/create_loop.html" class="external-link">global_loop</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h4>
<p></p><div class="arguments"><dl><dt><code>can_proceed</code></dt>
<dd><p>Function that should return a logical value. If <code>TRUE</code> is returned, then the next scheduled work will be executed. By default, this function checks if <code><a href="https://future.futureverse.org/reference/nbrOfWorkers.html" class="external-link">future::nbrOfFreeWorkers()</a> &gt; 0</code></p></dd>


<dt><code>queue</code></dt>
<dd><p>Queue object to use to store the scheduled work. By default, this is a "First In, First Out" queue using <code><a href="https://r-lib.github.io/fastmap/reference/fastqueue.html" class="external-link">fastmap::fastqueue()</a></code>. If using your own queue, it should have the methods <code>$add(x)</code>, <code>$remove()</code>, <code>$size()</code>.</p></dd>


<dt><code>loop</code></dt>
<dd><p><span class="pkg">later</span> loop to use for calculating the next delayed check. Defaults to <code><a href="https://r-lib.github.io/later/reference/create_loop.html" class="external-link">later::global_loop()</a></code>.
Schedule work</p></dd>


</dl><p></p></div>
</div>

</div><p></p><hr><a id="method-WorkQueue-schedule_work"></a><div class="section">
<h3 id="method-schedule-work-">Method <code>schedule_work()</code><a class="anchor" aria-label="anchor" href="#method-schedule-work-"></a></h3>

<div class="section">
<h4 id="usage-1">Usage<a class="anchor" aria-label="anchor" href="#usage-1"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">WorkQueue</span><span class="op">$</span><span class="fu">schedule_work</span><span class="op">(</span><span class="va">fn</span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments-1">Arguments<a class="anchor" aria-label="anchor" href="#arguments-1"></a></h4>
<p></p><div class="arguments"><dl><dt><code>fn</code></dt>
<dd><p>function to execute when <code>can_proceed()</code> returns <code>TRUE</code>.</p></dd>


</dl><p></p></div>
</div>

</div><p></p><hr><a id="method-WorkQueue-clone"></a><div class="section">
<h3 id="method-clone-">Method <code>clone()</code><a class="anchor" aria-label="anchor" href="#method-clone-"></a></h3>
<p>The objects of this class are cloneable with this method.</p><div class="section">
<h4 id="usage-2">Usage<a class="anchor" aria-label="anchor" href="#usage-2"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">WorkQueue</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span>deep <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments-2">Arguments<a class="anchor" aria-label="anchor" href="#arguments-2"></a></h4>
<p></p><div class="arguments"><dl><dt><code>deep</code></dt>
<dd><p>Whether to make a deep clone.</p></dd>


</dl><p></p></div>
</div>

</div>

    </div>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Joe Cheng, Posit Software, PBC.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer></div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({


    apiKey: 'e02966c036b2b44dfdb6dede68b3b31b',
    indexName: 'rstudio',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script></body></html>

